{"ast":null,"code":"\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nexports.__esModule = true;\nexports[\"default\"] = void 0;\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nvar _asyncToGenerator2 = _interopRequireDefault(require(\"@babel/runtime/helpers/asyncToGenerator\"));\n\nvar _assertThisInitialized2 = _interopRequireDefault(require(\"@babel/runtime/helpers/assertThisInitialized\"));\n\nvar _inheritsLoose2 = _interopRequireDefault(require(\"@babel/runtime/helpers/inheritsLoose\"));\n\nvar _defineProperty2 = _interopRequireDefault(require(\"@babel/runtime/helpers/defineProperty\"));\n\nvar _events = _interopRequireDefault(require(\"events\"));\n\nvar POPUP = _interopRequireWildcard(require(\"../constants/popup\"));\n\nvar IFRAME = _interopRequireWildcard(require(\"../constants/iframe\"));\n\nvar UI = _interopRequireWildcard(require(\"../constants/ui\"));\n\nvar _showPopupRequest = require(\"./showPopupRequest\");\n\nvar _urlUtils = require(\"../utils/urlUtils\");\n\nvar _deferred = require(\"../utils/deferred\");\n\nfunction _getRequireWildcardCache(nodeInterop) {\n  if (typeof WeakMap !== \"function\") return null;\n  var cacheBabelInterop = new WeakMap();\n  var cacheNodeInterop = new WeakMap();\n  return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) {\n    return nodeInterop ? cacheNodeInterop : cacheBabelInterop;\n  })(nodeInterop);\n}\n\nfunction _interopRequireWildcard(obj, nodeInterop) {\n  if (!nodeInterop && obj && obj.__esModule) {\n    return obj;\n  }\n\n  if (obj === null || typeof obj !== \"object\" && typeof obj !== \"function\") {\n    return {\n      \"default\": obj\n    };\n  }\n\n  var cache = _getRequireWildcardCache(nodeInterop);\n\n  if (cache && cache.has(obj)) {\n    return cache.get(obj);\n  }\n\n  var newObj = {};\n  var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor;\n\n  for (var key in obj) {\n    if (key !== \"default\" && Object.prototype.hasOwnProperty.call(obj, key)) {\n      var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null;\n\n      if (desc && (desc.get || desc.set)) {\n        Object.defineProperty(newObj, key, desc);\n      } else {\n        newObj[key] = obj[key];\n      }\n    }\n  }\n\n  newObj[\"default\"] = obj;\n\n  if (cache) {\n    cache.set(obj, newObj);\n  }\n\n  return newObj;\n} // const POPUP_REQUEST_TIMEOUT = 602;\n\n\nvar POPUP_REQUEST_TIMEOUT = 850;\nvar POPUP_CLOSE_INTERVAL = 500;\nvar POPUP_OPEN_TIMEOUT = 3000;\n\nvar PopupManager = /*#__PURE__*/function (_EventEmitter) {\n  (0, _inheritsLoose2[\"default\"])(PopupManager, _EventEmitter); // Window\n\n  function PopupManager(settings) {\n    var _this;\n\n    _this = _EventEmitter.call(this) || this;\n    (0, _defineProperty2[\"default\"])((0, _assertThisInitialized2[\"default\"])(_this), \"requestTimeout\", 0);\n    (0, _defineProperty2[\"default\"])((0, _assertThisInitialized2[\"default\"])(_this), \"closeInterval\", 0);\n    (0, _defineProperty2[\"default\"])((0, _assertThisInitialized2[\"default\"])(_this), \"extensionTabId\", 0);\n    _this.settings = settings;\n    _this.origin = (0, _urlUtils.getOrigin)(settings.popupSrc);\n    _this.handleMessage = _this.handleMessage.bind((0, _assertThisInitialized2[\"default\"])(_this));\n    _this.iframeHandshake = (0, _deferred.create)(IFRAME.LOADED);\n\n    if (_this.settings.env === 'webextension') {\n      _this.handleExtensionConnect = _this.handleExtensionConnect.bind((0, _assertThisInitialized2[\"default\"])(_this));\n      _this.handleExtensionMessage = _this.handleExtensionMessage.bind((0, _assertThisInitialized2[\"default\"])(_this)); // $FlowIssue chrome not declared outside\n\n      chrome.runtime.onConnect.addListener(_this.handleExtensionConnect);\n    }\n\n    window.addEventListener('message', _this.handleMessage, false);\n    return _this;\n  }\n\n  var _proto = PopupManager.prototype;\n\n  _proto.request = function request(lazyLoad) {\n    var _this2 = this;\n\n    if (lazyLoad === void 0) {\n      lazyLoad = false;\n    } // popup request\n    // TODO: ie - open immediately and hide it but post handshake after timeout\n    // bring popup window to front\n\n\n    if (this.locked) {\n      if (this._window) {\n        if (this.settings.env === 'webextension') {\n          // $FlowIssue chrome not declared outside\n          chrome.tabs.update(this._window.id, {\n            active: true\n          });\n        } else {\n          this._window.focus();\n        }\n      }\n\n      return;\n    }\n\n    var openFn = this.open.bind(this);\n    this.locked = true;\n\n    if (!this.settings.supportedBrowser) {\n      openFn();\n    } else {\n      var timeout = lazyLoad || this.settings.env === 'webextension' ? 1 : POPUP_REQUEST_TIMEOUT;\n      this.requestTimeout = window.setTimeout(function () {\n        _this2.requestTimeout = 0;\n        openFn(lazyLoad);\n      }, timeout);\n    }\n  };\n\n  _proto.cancel = function cancel() {\n    this.close();\n  };\n\n  _proto.unlock = function unlock() {\n    this.locked = false;\n  };\n\n  _proto.open = function open(lazyLoad) {\n    var _this3 = this;\n\n    var src = this.settings.popupSrc;\n\n    if (!this.settings.supportedBrowser) {\n      this.openWrapper(src + \"#unsupported\");\n      return;\n    }\n\n    this.popupPromise = (0, _deferred.create)(POPUP.LOADED);\n    this.openWrapper(lazyLoad ? src + \"#loading\" : src);\n    this.closeInterval = window.setInterval(function () {\n      if (!_this3._window) return;\n\n      if (_this3.settings.env === 'webextension') {\n        // $FlowIssue chrome not declared outside\n        chrome.tabs.get(_this3._window.id, function (tab) {\n          if (!tab) {\n            _this3.close();\n\n            _this3.emit(POPUP.CLOSED);\n          }\n        });\n      } else if (_this3._window.closed) {\n        _this3.close();\n\n        _this3.emit(POPUP.CLOSED);\n      }\n    }, POPUP_CLOSE_INTERVAL); // open timeout will be cancelled by POPUP.BOOTSTRAP message\n\n    this.openTimeout = window.setTimeout(function () {\n      _this3.close();\n\n      (0, _showPopupRequest.showPopupRequest)(_this3.open.bind(_this3), function () {\n        _this3.emit(POPUP.CLOSED);\n      });\n    }, POPUP_OPEN_TIMEOUT);\n  };\n\n  _proto.openWrapper = function openWrapper(url) {\n    var _this4 = this;\n\n    if (this.settings.env === 'webextension') {\n      // $FlowIssue chrome not declared outside\n      chrome.windows.getCurrent(null, function (currentWindow) {\n        // Request coming from extension popup,\n        // create new window above instead of opening new tab\n        if (currentWindow.type !== 'normal') {\n          // $FlowIssue chrome not declared outside\n          chrome.windows.create({\n            url: url\n          }, function (newWindow) {\n            // $FlowIssue chrome not declared outside\n            chrome.tabs.query({\n              windowId: newWindow.id,\n              active: true\n            }, function (tabs) {\n              // eslint-disable-next-line prefer-destructuring\n              _this4._window = tabs[0];\n            });\n          });\n        } else {\n          // $FlowIssue chrome not declared outside\n          chrome.tabs.query({\n            currentWindow: true,\n            active: true\n          }, function (tabs) {\n            _this4.extensionTabId = tabs[0].id; // $FlowIssue chrome not declared outside\n\n            chrome.tabs.create({\n              url: url,\n              index: tabs[0].index + 1\n            }, function (tab) {\n              _this4._window = tab;\n            });\n          });\n        }\n      });\n    } else if (this.settings.env === 'electron') {\n      this._window = window.open(url, 'modal');\n    } else {\n      this._window = window.open('', '_blank');\n\n      if (this._window) {\n        this._window.location.href = url; // otherwise android/chrome loose window.opener reference\n      }\n    }\n  };\n\n  _proto.handleExtensionConnect = function handleExtensionConnect(port) {\n    if (port.name !== 'trezor-connect') return;\n\n    if (!this._window || this._window && this._window.id !== port.sender.tab.id) {\n      port.disconnect();\n      return;\n    } // since POPUP.BOOTSTRAP will not be handled by \"handleMessage\" we need to threat \"content-script\" connection as the same event\n    // popup is opened properly, now wait for POPUP.LOADED message (in this case handled by \"handleExtensionMessage\")\n\n\n    window.clearTimeout(this.openTimeout);\n    this.extensionPort = port; // $FlowIssue need to update ChromePort definition\n\n    this.extensionPort.onMessage.addListener(this.handleExtensionMessage);\n  };\n\n  _proto.handleExtensionMessage = function handleExtensionMessage(message) {\n    var _this5 = this;\n\n    if (!this.extensionPort) return;\n    var port = this.extensionPort;\n    var data = message.data;\n    if (!data || typeof data !== 'object') return;\n\n    if (data.type === POPUP.ERROR) {\n      // handle popup error\n      var errorMessage = data.payload && typeof data.payload.error === 'string' ? data.payload.error : null;\n      this.emit(POPUP.CLOSED, errorMessage ? \"Popup error: \" + errorMessage : null);\n      this.close();\n    } else if (data.type === POPUP.LOADED) {\n      if (this.popupPromise) {\n        this.popupPromise.resolve();\n      }\n\n      this.iframeHandshake.promise.then(function (useBroadcastChannel) {\n        port.postMessage({\n          type: POPUP.INIT,\n          payload: {\n            settings: _this5.settings,\n            useBroadcastChannel: useBroadcastChannel\n          }\n        });\n      });\n    } else if (data.type === POPUP.EXTENSION_USB_PERMISSIONS) {\n      // $FlowIssue chrome not declared outside\n      chrome.tabs.query({\n        currentWindow: true,\n        active: true\n      }, function (tabs) {\n        // $FlowIssue chrome not declared outside\n        chrome.tabs.create({\n          url: 'trezor-usb-permissions.html',\n          index: tabs[0].index + 1\n        }, function (_tab) {// do nothing\n        });\n      });\n    } else if (data.type === POPUP.CLOSE_WINDOW) {\n      this.emit(POPUP.CLOSED);\n      this.close();\n    }\n  };\n\n  _proto.handleMessage = function handleMessage(message) {\n    var _this6 = this; // ignore messages from domain other then popup origin and without data\n    // const data: CoreMessage = message.data;\n\n\n    var data = message.data;\n    if ((0, _urlUtils.getOrigin)(message.origin) !== this.origin || !data || typeof data !== 'object') return;\n\n    if (data.type === IFRAME.LOADED) {\n      var useBroadcastChannel = data.payload && typeof data.payload.useBroadcastChannel === 'boolean' ? data.payload.useBroadcastChannel : false;\n      this.iframeHandshake.resolve(useBroadcastChannel);\n    } else if (data.type === POPUP.BOOTSTRAP) {\n      // popup is opened properly, now wait for POPUP.LOADED message\n      window.clearTimeout(this.openTimeout);\n    } else if (data.type === POPUP.ERROR && this._window) {\n      var errorMessage = data.payload && typeof data.payload.error === 'string' ? data.payload.error : null;\n      this.emit(POPUP.CLOSED, errorMessage ? \"Popup error: \" + errorMessage : null);\n      this.close();\n    } else if (data.type === POPUP.LOADED) {\n      if (this.popupPromise) {\n        this.popupPromise.resolve();\n      } // popup is successfully loaded\n\n\n      this.iframeHandshake.promise.then(function (useBroadcastChannel) {\n        _this6._window.postMessage({\n          type: POPUP.INIT,\n          payload: {\n            settings: _this6.settings,\n            useBroadcastChannel: useBroadcastChannel\n          }\n        }, _this6.origin);\n      }); // send ConnectSettings to popup\n      // note this settings and iframe.ConnectSettings could be different (especially: origin, popup, webusb, debug)\n      // now popup is able to load assets\n    } else if (data.type === POPUP.CANCEL_POPUP_REQUEST || data.type === UI.CLOSE_UI_WINDOW) {\n      this.close();\n    }\n  };\n\n  _proto.close = function close() {\n    this.locked = false;\n    this.popupPromise = undefined;\n\n    if (this.requestTimeout) {\n      window.clearTimeout(this.requestTimeout);\n      this.requestTimeout = 0;\n    }\n\n    if (this.openTimeout) {\n      window.clearTimeout(this.openTimeout);\n      this.openTimeout = 0;\n    }\n\n    if (this.closeInterval) {\n      window.clearInterval(this.closeInterval);\n      this.closeInterval = 0;\n    }\n\n    if (this.extensionPort) {\n      this.extensionPort.disconnect();\n      this.extensionPort = null;\n    } // switch to previously focused tab\n\n\n    if (this.extensionTabId) {\n      // $FlowIssue chrome not declared outside\n      chrome.tabs.update(this.extensionTabId, {\n        active: true\n      });\n      this.extensionTabId = 0;\n    }\n\n    if (this._window) {\n      if (this.settings.env === 'webextension') {\n        // eslint-disable-next-line no-unused-vars\n        var _e = chrome.runtime.lastError; // $FlowIssue chrome not declared outside\n\n        chrome.tabs.remove(this._window.id, function () {\n          // eslint-disable-next-line no-unused-vars\n          _e = chrome.runtime.lastError;\n        });\n      } else {\n        this._window.close();\n      }\n\n      this._window = null;\n    }\n  };\n\n  _proto.postMessage = /*#__PURE__*/function () {\n    var _postMessage = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee(message) {\n      var _this7 = this;\n\n      return _regenerator[\"default\"].wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              if (!(!this._window && message.type !== UI.REQUEST_UI_WINDOW && this.openTimeout)) {\n                _context.next = 4;\n                break;\n              }\n\n              this.close();\n              (0, _showPopupRequest.showPopupRequest)(this.open.bind(this), function () {\n                _this7.emit(POPUP.CLOSED);\n              });\n              return _context.abrupt(\"return\");\n\n            case 4:\n              if (!this.popupPromise) {\n                _context.next = 7;\n                break;\n              }\n\n              _context.next = 7;\n              return this.popupPromise.promise;\n\n            case 7:\n              // post message to popup window\n              if (this._window) {\n                this._window.postMessage(message, this.origin);\n              }\n\n            case 8:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee, this);\n    }));\n\n    function postMessage(_x) {\n      return _postMessage.apply(this, arguments);\n    }\n\n    return postMessage;\n  }();\n\n  return PopupManager;\n}(_events[\"default\"]);\n\nexports[\"default\"] = PopupManager;","map":{"version":3,"sources":["/Users/massimilianoalbini/Documents/gain-drop/node_modules/trezor-connect/lib/popup/PopupManager.js"],"names":["_interopRequireDefault","require","exports","__esModule","_regenerator","_asyncToGenerator2","_assertThisInitialized2","_inheritsLoose2","_defineProperty2","_events","POPUP","_interopRequireWildcard","IFRAME","UI","_showPopupRequest","_urlUtils","_deferred","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","call","desc","set","POPUP_REQUEST_TIMEOUT","POPUP_CLOSE_INTERVAL","POPUP_OPEN_TIMEOUT","PopupManager","_EventEmitter","settings","_this","origin","getOrigin","popupSrc","handleMessage","bind","iframeHandshake","create","LOADED","env","handleExtensionConnect","handleExtensionMessage","chrome","runtime","onConnect","addListener","window","addEventListener","_proto","request","lazyLoad","_this2","locked","_window","tabs","update","id","active","focus","openFn","open","supportedBrowser","timeout","requestTimeout","setTimeout","cancel","close","unlock","_this3","src","openWrapper","popupPromise","closeInterval","setInterval","tab","emit","CLOSED","closed","openTimeout","showPopupRequest","url","_this4","windows","getCurrent","currentWindow","type","newWindow","query","windowId","extensionTabId","index","location","href","port","name","sender","disconnect","clearTimeout","extensionPort","onMessage","message","_this5","data","ERROR","errorMessage","payload","error","resolve","promise","then","useBroadcastChannel","postMessage","INIT","EXTENSION_USB_PERMISSIONS","_tab","CLOSE_WINDOW","_this6","BOOTSTRAP","CANCEL_POPUP_REQUEST","CLOSE_UI_WINDOW","undefined","clearInterval","_e","lastError","remove","_postMessage","mark","_callee","_this7","wrap","_callee$","_context","prev","next","REQUEST_UI_WINDOW","abrupt","stop","_x","apply","arguments"],"mappings":"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","sourcesContent":["\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nexports.__esModule = true;\nexports[\"default\"] = void 0;\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nvar _asyncToGenerator2 = _interopRequireDefault(require(\"@babel/runtime/helpers/asyncToGenerator\"));\n\nvar _assertThisInitialized2 = _interopRequireDefault(require(\"@babel/runtime/helpers/assertThisInitialized\"));\n\nvar _inheritsLoose2 = _interopRequireDefault(require(\"@babel/runtime/helpers/inheritsLoose\"));\n\nvar _defineProperty2 = _interopRequireDefault(require(\"@babel/runtime/helpers/defineProperty\"));\n\nvar _events = _interopRequireDefault(require(\"events\"));\n\nvar POPUP = _interopRequireWildcard(require(\"../constants/popup\"));\n\nvar IFRAME = _interopRequireWildcard(require(\"../constants/iframe\"));\n\nvar UI = _interopRequireWildcard(require(\"../constants/ui\"));\n\nvar _showPopupRequest = require(\"./showPopupRequest\");\n\nvar _urlUtils = require(\"../utils/urlUtils\");\n\nvar _deferred = require(\"../utils/deferred\");\n\nfunction _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== \"function\") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }\n\nfunction _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== \"object\" && typeof obj !== \"function\") { return { \"default\": obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== \"default\" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj[\"default\"] = obj; if (cache) { cache.set(obj, newObj); } return newObj; }\n\n// const POPUP_REQUEST_TIMEOUT = 602;\nvar POPUP_REQUEST_TIMEOUT = 850;\nvar POPUP_CLOSE_INTERVAL = 500;\nvar POPUP_OPEN_TIMEOUT = 3000;\n\nvar PopupManager = /*#__PURE__*/function (_EventEmitter) {\n  (0, _inheritsLoose2[\"default\"])(PopupManager, _EventEmitter);\n\n  // Window\n  function PopupManager(settings) {\n    var _this;\n\n    _this = _EventEmitter.call(this) || this;\n    (0, _defineProperty2[\"default\"])((0, _assertThisInitialized2[\"default\"])(_this), \"requestTimeout\", 0);\n    (0, _defineProperty2[\"default\"])((0, _assertThisInitialized2[\"default\"])(_this), \"closeInterval\", 0);\n    (0, _defineProperty2[\"default\"])((0, _assertThisInitialized2[\"default\"])(_this), \"extensionTabId\", 0);\n    _this.settings = settings;\n    _this.origin = (0, _urlUtils.getOrigin)(settings.popupSrc);\n    _this.handleMessage = _this.handleMessage.bind((0, _assertThisInitialized2[\"default\"])(_this));\n    _this.iframeHandshake = (0, _deferred.create)(IFRAME.LOADED);\n\n    if (_this.settings.env === 'webextension') {\n      _this.handleExtensionConnect = _this.handleExtensionConnect.bind((0, _assertThisInitialized2[\"default\"])(_this));\n      _this.handleExtensionMessage = _this.handleExtensionMessage.bind((0, _assertThisInitialized2[\"default\"])(_this)); // $FlowIssue chrome not declared outside\n\n      chrome.runtime.onConnect.addListener(_this.handleExtensionConnect);\n    }\n\n    window.addEventListener('message', _this.handleMessage, false);\n    return _this;\n  }\n\n  var _proto = PopupManager.prototype;\n\n  _proto.request = function request(lazyLoad) {\n    var _this2 = this;\n\n    if (lazyLoad === void 0) {\n      lazyLoad = false;\n    }\n\n    // popup request\n    // TODO: ie - open immediately and hide it but post handshake after timeout\n    // bring popup window to front\n    if (this.locked) {\n      if (this._window) {\n        if (this.settings.env === 'webextension') {\n          // $FlowIssue chrome not declared outside\n          chrome.tabs.update(this._window.id, {\n            active: true\n          });\n        } else {\n          this._window.focus();\n        }\n      }\n\n      return;\n    }\n\n    var openFn = this.open.bind(this);\n    this.locked = true;\n\n    if (!this.settings.supportedBrowser) {\n      openFn();\n    } else {\n      var timeout = lazyLoad || this.settings.env === 'webextension' ? 1 : POPUP_REQUEST_TIMEOUT;\n      this.requestTimeout = window.setTimeout(function () {\n        _this2.requestTimeout = 0;\n        openFn(lazyLoad);\n      }, timeout);\n    }\n  };\n\n  _proto.cancel = function cancel() {\n    this.close();\n  };\n\n  _proto.unlock = function unlock() {\n    this.locked = false;\n  };\n\n  _proto.open = function open(lazyLoad) {\n    var _this3 = this;\n\n    var src = this.settings.popupSrc;\n\n    if (!this.settings.supportedBrowser) {\n      this.openWrapper(src + \"#unsupported\");\n      return;\n    }\n\n    this.popupPromise = (0, _deferred.create)(POPUP.LOADED);\n    this.openWrapper(lazyLoad ? src + \"#loading\" : src);\n    this.closeInterval = window.setInterval(function () {\n      if (!_this3._window) return;\n\n      if (_this3.settings.env === 'webextension') {\n        // $FlowIssue chrome not declared outside\n        chrome.tabs.get(_this3._window.id, function (tab) {\n          if (!tab) {\n            _this3.close();\n\n            _this3.emit(POPUP.CLOSED);\n          }\n        });\n      } else if (_this3._window.closed) {\n        _this3.close();\n\n        _this3.emit(POPUP.CLOSED);\n      }\n    }, POPUP_CLOSE_INTERVAL); // open timeout will be cancelled by POPUP.BOOTSTRAP message\n\n    this.openTimeout = window.setTimeout(function () {\n      _this3.close();\n\n      (0, _showPopupRequest.showPopupRequest)(_this3.open.bind(_this3), function () {\n        _this3.emit(POPUP.CLOSED);\n      });\n    }, POPUP_OPEN_TIMEOUT);\n  };\n\n  _proto.openWrapper = function openWrapper(url) {\n    var _this4 = this;\n\n    if (this.settings.env === 'webextension') {\n      // $FlowIssue chrome not declared outside\n      chrome.windows.getCurrent(null, function (currentWindow) {\n        // Request coming from extension popup,\n        // create new window above instead of opening new tab\n        if (currentWindow.type !== 'normal') {\n          // $FlowIssue chrome not declared outside\n          chrome.windows.create({\n            url: url\n          }, function (newWindow) {\n            // $FlowIssue chrome not declared outside\n            chrome.tabs.query({\n              windowId: newWindow.id,\n              active: true\n            }, function (tabs) {\n              // eslint-disable-next-line prefer-destructuring\n              _this4._window = tabs[0];\n            });\n          });\n        } else {\n          // $FlowIssue chrome not declared outside\n          chrome.tabs.query({\n            currentWindow: true,\n            active: true\n          }, function (tabs) {\n            _this4.extensionTabId = tabs[0].id; // $FlowIssue chrome not declared outside\n\n            chrome.tabs.create({\n              url: url,\n              index: tabs[0].index + 1\n            }, function (tab) {\n              _this4._window = tab;\n            });\n          });\n        }\n      });\n    } else if (this.settings.env === 'electron') {\n      this._window = window.open(url, 'modal');\n    } else {\n      this._window = window.open('', '_blank');\n\n      if (this._window) {\n        this._window.location.href = url; // otherwise android/chrome loose window.opener reference\n      }\n    }\n  };\n\n  _proto.handleExtensionConnect = function handleExtensionConnect(port) {\n    if (port.name !== 'trezor-connect') return;\n\n    if (!this._window || this._window && this._window.id !== port.sender.tab.id) {\n      port.disconnect();\n      return;\n    } // since POPUP.BOOTSTRAP will not be handled by \"handleMessage\" we need to threat \"content-script\" connection as the same event\n    // popup is opened properly, now wait for POPUP.LOADED message (in this case handled by \"handleExtensionMessage\")\n\n\n    window.clearTimeout(this.openTimeout);\n    this.extensionPort = port; // $FlowIssue need to update ChromePort definition\n\n    this.extensionPort.onMessage.addListener(this.handleExtensionMessage);\n  };\n\n  _proto.handleExtensionMessage = function handleExtensionMessage(message) {\n    var _this5 = this;\n\n    if (!this.extensionPort) return;\n    var port = this.extensionPort;\n    var data = message.data;\n    if (!data || typeof data !== 'object') return;\n\n    if (data.type === POPUP.ERROR) {\n      // handle popup error\n      var errorMessage = data.payload && typeof data.payload.error === 'string' ? data.payload.error : null;\n      this.emit(POPUP.CLOSED, errorMessage ? \"Popup error: \" + errorMessage : null);\n      this.close();\n    } else if (data.type === POPUP.LOADED) {\n      if (this.popupPromise) {\n        this.popupPromise.resolve();\n      }\n\n      this.iframeHandshake.promise.then(function (useBroadcastChannel) {\n        port.postMessage({\n          type: POPUP.INIT,\n          payload: {\n            settings: _this5.settings,\n            useBroadcastChannel: useBroadcastChannel\n          }\n        });\n      });\n    } else if (data.type === POPUP.EXTENSION_USB_PERMISSIONS) {\n      // $FlowIssue chrome not declared outside\n      chrome.tabs.query({\n        currentWindow: true,\n        active: true\n      }, function (tabs) {\n        // $FlowIssue chrome not declared outside\n        chrome.tabs.create({\n          url: 'trezor-usb-permissions.html',\n          index: tabs[0].index + 1\n        }, function (_tab) {// do nothing\n        });\n      });\n    } else if (data.type === POPUP.CLOSE_WINDOW) {\n      this.emit(POPUP.CLOSED);\n      this.close();\n    }\n  };\n\n  _proto.handleMessage = function handleMessage(message) {\n    var _this6 = this;\n\n    // ignore messages from domain other then popup origin and without data\n    // const data: CoreMessage = message.data;\n    var data = message.data;\n    if ((0, _urlUtils.getOrigin)(message.origin) !== this.origin || !data || typeof data !== 'object') return;\n\n    if (data.type === IFRAME.LOADED) {\n      var useBroadcastChannel = data.payload && typeof data.payload.useBroadcastChannel === 'boolean' ? data.payload.useBroadcastChannel : false;\n      this.iframeHandshake.resolve(useBroadcastChannel);\n    } else if (data.type === POPUP.BOOTSTRAP) {\n      // popup is opened properly, now wait for POPUP.LOADED message\n      window.clearTimeout(this.openTimeout);\n    } else if (data.type === POPUP.ERROR && this._window) {\n      var errorMessage = data.payload && typeof data.payload.error === 'string' ? data.payload.error : null;\n      this.emit(POPUP.CLOSED, errorMessage ? \"Popup error: \" + errorMessage : null);\n      this.close();\n    } else if (data.type === POPUP.LOADED) {\n      if (this.popupPromise) {\n        this.popupPromise.resolve();\n      } // popup is successfully loaded\n\n\n      this.iframeHandshake.promise.then(function (useBroadcastChannel) {\n        _this6._window.postMessage({\n          type: POPUP.INIT,\n          payload: {\n            settings: _this6.settings,\n            useBroadcastChannel: useBroadcastChannel\n          }\n        }, _this6.origin);\n      }); // send ConnectSettings to popup\n      // note this settings and iframe.ConnectSettings could be different (especially: origin, popup, webusb, debug)\n      // now popup is able to load assets\n    } else if (data.type === POPUP.CANCEL_POPUP_REQUEST || data.type === UI.CLOSE_UI_WINDOW) {\n      this.close();\n    }\n  };\n\n  _proto.close = function close() {\n    this.locked = false;\n    this.popupPromise = undefined;\n\n    if (this.requestTimeout) {\n      window.clearTimeout(this.requestTimeout);\n      this.requestTimeout = 0;\n    }\n\n    if (this.openTimeout) {\n      window.clearTimeout(this.openTimeout);\n      this.openTimeout = 0;\n    }\n\n    if (this.closeInterval) {\n      window.clearInterval(this.closeInterval);\n      this.closeInterval = 0;\n    }\n\n    if (this.extensionPort) {\n      this.extensionPort.disconnect();\n      this.extensionPort = null;\n    } // switch to previously focused tab\n\n\n    if (this.extensionTabId) {\n      // $FlowIssue chrome not declared outside\n      chrome.tabs.update(this.extensionTabId, {\n        active: true\n      });\n      this.extensionTabId = 0;\n    }\n\n    if (this._window) {\n      if (this.settings.env === 'webextension') {\n        // eslint-disable-next-line no-unused-vars\n        var _e = chrome.runtime.lastError; // $FlowIssue chrome not declared outside\n\n        chrome.tabs.remove(this._window.id, function () {\n          // eslint-disable-next-line no-unused-vars\n          _e = chrome.runtime.lastError;\n        });\n      } else {\n        this._window.close();\n      }\n\n      this._window = null;\n    }\n  };\n\n  _proto.postMessage = /*#__PURE__*/function () {\n    var _postMessage = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee(message) {\n      var _this7 = this;\n\n      return _regenerator[\"default\"].wrap(function _callee$(_context) {\n        while (1) {\n          switch (_context.prev = _context.next) {\n            case 0:\n              if (!(!this._window && message.type !== UI.REQUEST_UI_WINDOW && this.openTimeout)) {\n                _context.next = 4;\n                break;\n              }\n\n              this.close();\n              (0, _showPopupRequest.showPopupRequest)(this.open.bind(this), function () {\n                _this7.emit(POPUP.CLOSED);\n              });\n              return _context.abrupt(\"return\");\n\n            case 4:\n              if (!this.popupPromise) {\n                _context.next = 7;\n                break;\n              }\n\n              _context.next = 7;\n              return this.popupPromise.promise;\n\n            case 7:\n              // post message to popup window\n              if (this._window) {\n                this._window.postMessage(message, this.origin);\n              }\n\n            case 8:\n            case \"end\":\n              return _context.stop();\n          }\n        }\n      }, _callee, this);\n    }));\n\n    function postMessage(_x) {\n      return _postMessage.apply(this, arguments);\n    }\n\n    return postMessage;\n  }();\n\n  return PopupManager;\n}(_events[\"default\"]);\n\nexports[\"default\"] = PopupManager;"]},"metadata":{},"sourceType":"script"}