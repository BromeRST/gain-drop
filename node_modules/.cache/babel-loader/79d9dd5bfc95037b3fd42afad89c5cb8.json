{"ast":null,"code":"\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nexports.__esModule = true;\nexports.disableWebUSB = exports.requestLogin = exports.customMessage = exports.getSettings = exports.renderWebUSBButton = exports.uiResponse = exports.call = exports.init = exports.cancel = exports.dispose = exports.manifest = exports.eventEmitter = void 0;\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nvar _asyncToGenerator2 = _interopRequireDefault(require(\"@babel/runtime/helpers/asyncToGenerator\"));\n\nvar _defineProperty2 = _interopRequireDefault(require(\"@babel/runtime/helpers/defineProperty\"));\n\nvar _events = _interopRequireDefault(require(\"events\"));\n\nvar _PopupManager = _interopRequireDefault(require(\"../../popup/PopupManager\"));\n\nvar iframe = _interopRequireWildcard(require(\"../../iframe/builder\"));\n\nvar _button = _interopRequireDefault(require(\"../../webusb/button\"));\n\nvar _message = require(\"../../message\");\n\nvar _builder2 = require(\"../../message/builder\");\n\nvar _ConnectSettings = require(\"../../data/ConnectSettings\");\n\nvar _debug = require(\"../../utils/debug\");\n\nvar _constants = require(\"../../constants\");\n\nvar $T = _interopRequireWildcard(require(\"../../types\"));\n\nfunction _getRequireWildcardCache(nodeInterop) {\n  if (typeof WeakMap !== \"function\") return null;\n  var cacheBabelInterop = new WeakMap();\n  var cacheNodeInterop = new WeakMap();\n  return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) {\n    return nodeInterop ? cacheNodeInterop : cacheBabelInterop;\n  })(nodeInterop);\n}\n\nfunction _interopRequireWildcard(obj, nodeInterop) {\n  if (!nodeInterop && obj && obj.__esModule) {\n    return obj;\n  }\n\n  if (obj === null || typeof obj !== \"object\" && typeof obj !== \"function\") {\n    return {\n      \"default\": obj\n    };\n  }\n\n  var cache = _getRequireWildcardCache(nodeInterop);\n\n  if (cache && cache.has(obj)) {\n    return cache.get(obj);\n  }\n\n  var newObj = {};\n  var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor;\n\n  for (var key in obj) {\n    if (key !== \"default\" && Object.prototype.hasOwnProperty.call(obj, key)) {\n      var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null;\n\n      if (desc && (desc.get || desc.set)) {\n        Object.defineProperty(newObj, key, desc);\n      } else {\n        newObj[key] = obj[key];\n      }\n    }\n  }\n\n  newObj[\"default\"] = obj;\n\n  if (cache) {\n    cache.set(obj, newObj);\n  }\n\n  return newObj;\n}\n\nfunction ownKeys(object, enumerableOnly) {\n  var keys = Object.keys(object);\n\n  if (Object.getOwnPropertySymbols) {\n    var symbols = Object.getOwnPropertySymbols(object);\n\n    if (enumerableOnly) {\n      symbols = symbols.filter(function (sym) {\n        return Object.getOwnPropertyDescriptor(object, sym).enumerable;\n      });\n    }\n\n    keys.push.apply(keys, symbols);\n  }\n\n  return keys;\n}\n\nfunction _objectSpread(target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = arguments[i] != null ? arguments[i] : {};\n\n    if (i % 2) {\n      ownKeys(Object(source), true).forEach(function (key) {\n        (0, _defineProperty2[\"default\"])(target, key, source[key]);\n      });\n    } else if (Object.getOwnPropertyDescriptors) {\n      Object.defineProperties(target, Object.getOwnPropertyDescriptors(source));\n    } else {\n      ownKeys(Object(source)).forEach(function (key) {\n        Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key));\n      });\n    }\n  }\n\n  return target;\n}\n\nvar eventEmitter = new _events[\"default\"]();\nexports.eventEmitter = eventEmitter;\n\nvar _log = (0, _debug.initLog)('[trezor-connect.js]');\n\nvar _settings = (0, _ConnectSettings.parse)();\n\nvar _popupManager;\n\nvar initPopupManager = function initPopupManager() {\n  var pm = new _PopupManager[\"default\"](_settings);\n  pm.on(_constants.POPUP.CLOSED, function (error) {\n    iframe.postMessage({\n      type: _constants.POPUP.CLOSED,\n      payload: error ? {\n        error: error\n      } : null\n    }, false);\n  });\n  return pm;\n};\n\nvar manifest = function manifest(data) {\n  _settings = (0, _ConnectSettings.parse)(_objectSpread(_objectSpread({}, _settings), {}, {\n    manifest: data\n  }));\n};\n\nexports.manifest = manifest;\n\nvar dispose = function dispose() {\n  eventEmitter.removeAllListeners();\n  iframe.dispose();\n  _settings = (0, _ConnectSettings.parse)();\n\n  if (_popupManager) {\n    _popupManager.close();\n  }\n};\n\nexports.dispose = dispose;\n\nvar cancel = function cancel(error) {\n  if (_popupManager) {\n    _popupManager.emit(_constants.POPUP.CLOSED, error);\n  }\n}; // handle message received from iframe\n\n\nexports.cancel = cancel;\n\nvar handleMessage = function handleMessage(messageEvent) {\n  // ignore messages from domain other then iframe origin\n  if (messageEvent.origin !== iframe.origin) return;\n  var message = (0, _message.parseMessage)(messageEvent.data);\n  var event = message.event,\n      type = message.type,\n      payload = message.payload;\n  var id = message.id || 0;\n\n  _log.log('handleMessage', message);\n\n  switch (event) {\n    case _constants.RESPONSE_EVENT:\n      if (iframe.messagePromises[id]) {\n        // resolve message promise (send result of call method)\n        iframe.messagePromises[id].resolve({\n          id: id,\n          success: message.success,\n          payload: payload\n        });\n        delete iframe.messagePromises[id];\n      } else {\n        _log.warn(\"Unknown message id \" + id);\n      }\n\n      break;\n\n    case _constants.DEVICE_EVENT:\n      // pass DEVICE event up to html\n      eventEmitter.emit(event, message);\n      eventEmitter.emit(type, payload); // DEVICE_EVENT also emit single events (connect/disconnect...)\n\n      break;\n\n    case _constants.TRANSPORT_EVENT:\n      eventEmitter.emit(event, message);\n      eventEmitter.emit(type, payload);\n      break;\n\n    case _constants.BLOCKCHAIN_EVENT:\n      eventEmitter.emit(event, message);\n      eventEmitter.emit(type, payload);\n      break;\n\n    case _constants.UI_EVENT:\n      if (type === _constants.IFRAME.BOOTSTRAP) {\n        iframe.clearTimeout();\n        break;\n      }\n\n      if (type === _constants.IFRAME.LOADED) {\n        iframe.initPromise.resolve();\n      }\n\n      if (type === _constants.IFRAME.ERROR) {\n        iframe.initPromise.reject(payload.error);\n      } // pass UI event up\n\n\n      eventEmitter.emit(event, message);\n      eventEmitter.emit(type, payload);\n      break;\n\n    default:\n      _log.log('Undefined message', event, messageEvent);\n\n  }\n};\n\nvar init = /*#__PURE__*/function () {\n  var _ref = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee(settings) {\n    return _regenerator[\"default\"].wrap(function _callee$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            if (settings === void 0) {\n              settings = {};\n            }\n\n            if (!iframe.instance) {\n              _context.next = 3;\n              break;\n            }\n\n            throw _constants.ERRORS.TypedError('Init_AlreadyInitialized');\n\n          case 3:\n            _settings = (0, _ConnectSettings.parse)(_objectSpread(_objectSpread({}, _settings), settings));\n\n            if (_settings.manifest) {\n              _context.next = 6;\n              break;\n            }\n\n            throw _constants.ERRORS.TypedError('Init_ManifestMissing');\n\n          case 6:\n            if (!_settings.lazyLoad) {\n              _context.next = 9;\n              break;\n            } // reset \"lazyLoad\" after first use\n\n\n            _settings.lazyLoad = false;\n            return _context.abrupt(\"return\");\n\n          case 9:\n            if (!_popupManager) {\n              _popupManager = initPopupManager();\n            }\n\n            _log.enabled = !!_settings.debug;\n            window.addEventListener('message', handleMessage);\n            window.addEventListener('unload', dispose);\n            _context.next = 15;\n            return iframe.init(_settings);\n\n          case 15:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }, _callee);\n  }));\n\n  return function init(_x) {\n    return _ref.apply(this, arguments);\n  };\n}();\n\nexports.init = init;\n\nvar call = /*#__PURE__*/function () {\n  var _ref2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee2(params) {\n    var response;\n    return _regenerator[\"default\"].wrap(function _callee2$(_context2) {\n      while (1) {\n        switch (_context2.prev = _context2.next) {\n          case 0:\n            if (!(!iframe.instance && !iframe.timeout)) {\n              _context2.next = 15;\n              break;\n            } // init popup with lazy loading before iframe initialization\n\n\n            _settings = (0, _ConnectSettings.parse)(_settings);\n\n            if (_settings.manifest) {\n              _context2.next = 4;\n              break;\n            }\n\n            return _context2.abrupt(\"return\", (0, _message.errorMessage)(_constants.ERRORS.TypedError('Init_ManifestMissing')));\n\n          case 4:\n            if (!_popupManager) {\n              _popupManager = initPopupManager();\n            }\n\n            _popupManager.request(true); // auto init with default settings\n\n\n            _context2.prev = 6;\n            _context2.next = 9;\n            return init(_settings);\n\n          case 9:\n            _context2.next = 15;\n            break;\n\n          case 11:\n            _context2.prev = 11;\n            _context2.t0 = _context2[\"catch\"](6);\n\n            if (_popupManager) {\n              // Catch fatal iframe errors (not loading)\n              if (['Init_IframeBlocked', 'Init_IframeTimeout'].includes(_context2.t0.code)) {\n                _popupManager.postMessage((0, _builder2.UiMessage)(_constants.UI.IFRAME_FAILURE));\n              } else {\n                _popupManager.close();\n              }\n            }\n\n            return _context2.abrupt(\"return\", (0, _message.errorMessage)(_context2.t0));\n\n          case 15:\n            if (!iframe.timeout) {\n              _context2.next = 17;\n              break;\n            }\n\n            return _context2.abrupt(\"return\", (0, _message.errorMessage)(_constants.ERRORS.TypedError('Init_ManifestMissing')));\n\n          case 17:\n            if (!iframe.error) {\n              _context2.next = 19;\n              break;\n            }\n\n            return _context2.abrupt(\"return\", (0, _message.errorMessage)(iframe.error));\n\n          case 19:\n            // request popup window it might be used in the future\n            if (_settings.popup && _popupManager) {\n              _popupManager.request();\n            } // post message to iframe\n\n\n            _context2.prev = 20;\n            _context2.next = 23;\n            return iframe.postMessage({\n              type: _constants.IFRAME.CALL,\n              payload: params\n            });\n\n          case 23:\n            response = _context2.sent;\n\n            if (!response) {\n              _context2.next = 27;\n              break;\n            }\n\n            if (!response.success && response.payload.code !== 'Device_CallInProgress' && _popupManager) {\n              _popupManager.unlock();\n            }\n\n            return _context2.abrupt(\"return\", response);\n\n          case 27:\n            if (_popupManager) {\n              _popupManager.unlock();\n            }\n\n            return _context2.abrupt(\"return\", (0, _message.errorMessage)(_constants.ERRORS.TypedError('Method_NoResponse')));\n\n          case 31:\n            _context2.prev = 31;\n            _context2.t1 = _context2[\"catch\"](20);\n\n            _log.error('__call error', _context2.t1);\n\n            if (_popupManager) {\n              _popupManager.close();\n            }\n\n            return _context2.abrupt(\"return\", (0, _message.errorMessage)(_context2.t1));\n\n          case 36:\n          case \"end\":\n            return _context2.stop();\n        }\n      }\n    }, _callee2, null, [[6, 11], [20, 31]]);\n  }));\n\n  return function call(_x2) {\n    return _ref2.apply(this, arguments);\n  };\n}();\n\nexports.call = call;\n\nvar customMessageResponse = function customMessageResponse(payload) {\n  iframe.postMessage({\n    event: _constants.UI_EVENT,\n    type: _constants.UI.CUSTOM_MESSAGE_RESPONSE,\n    payload: payload\n  });\n};\n\nvar uiResponse = function uiResponse(response) {\n  if (!iframe.instance) {\n    throw _constants.ERRORS.TypedError('Init_NotInitialized');\n  }\n\n  var type = response.type,\n      payload = response.payload;\n  iframe.postMessage({\n    event: _constants.UI_EVENT,\n    type: type,\n    payload: payload\n  });\n};\n\nexports.uiResponse = uiResponse;\n\nvar renderWebUSBButton = function renderWebUSBButton(className) {\n  (0, _button[\"default\"])(className, _settings.webusbSrc, iframe.origin);\n};\n\nexports.renderWebUSBButton = renderWebUSBButton;\n\nvar getSettings = function getSettings() {\n  if (!iframe.instance) {\n    return Promise.resolve((0, _message.errorMessage)(_constants.ERRORS.TypedError('Init_NotInitialized')));\n  }\n\n  return call({\n    method: 'getSettings'\n  });\n};\n\nexports.getSettings = getSettings;\n\nvar customMessage = /*#__PURE__*/function () {\n  var _ref3 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee4(params) {\n    var callback, customMessageListener, response;\n    return _regenerator[\"default\"].wrap(function _callee4$(_context4) {\n      while (1) {\n        switch (_context4.prev = _context4.next) {\n          case 0:\n            if (iframe.instance) {\n              _context4.next = 2;\n              break;\n            }\n\n            throw _constants.ERRORS.TypedError('Init_NotInitialized');\n\n          case 2:\n            if (!(typeof params.callback !== 'function')) {\n              _context4.next = 4;\n              break;\n            }\n\n            return _context4.abrupt(\"return\", (0, _message.errorMessage)(_constants.ERRORS.TypedError('Method_CustomMessage_Callback')));\n\n          case 4:\n            // TODO: set message listener only if iframe is loaded correctly\n            callback = params.callback;\n\n            customMessageListener = /*#__PURE__*/function () {\n              var _ref4 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee3(event) {\n                var data, payload;\n                return _regenerator[\"default\"].wrap(function _callee3$(_context3) {\n                  while (1) {\n                    switch (_context3.prev = _context3.next) {\n                      case 0:\n                        data = event.data;\n\n                        if (!(data && data.type === _constants.UI.CUSTOM_MESSAGE_REQUEST)) {\n                          _context3.next = 6;\n                          break;\n                        }\n\n                        _context3.next = 4;\n                        return callback(data.payload);\n\n                      case 4:\n                        payload = _context3.sent;\n\n                        if (payload) {\n                          customMessageResponse(payload);\n                        } else {\n                          customMessageResponse({\n                            message: 'release'\n                          });\n                        }\n\n                      case 6:\n                      case \"end\":\n                        return _context3.stop();\n                    }\n                  }\n                }, _callee3);\n              }));\n\n              return function customMessageListener(_x4) {\n                return _ref4.apply(this, arguments);\n              };\n            }();\n\n            window.addEventListener('message', customMessageListener, false);\n            _context4.next = 9;\n            return call(_objectSpread(_objectSpread({\n              method: 'customMessage'\n            }, params), {}, {\n              callback: null\n            }));\n\n          case 9:\n            response = _context4.sent;\n            window.removeEventListener('message', customMessageListener);\n            return _context4.abrupt(\"return\", response);\n\n          case 12:\n          case \"end\":\n            return _context4.stop();\n        }\n      }\n    }, _callee4);\n  }));\n\n  return function customMessage(_x3) {\n    return _ref3.apply(this, arguments);\n  };\n}();\n\nexports.customMessage = customMessage;\n\nvar requestLogin = /*#__PURE__*/function () {\n  var _ref5 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee6(params) {\n    var callback, loginChallengeListener, response;\n    return _regenerator[\"default\"].wrap(function _callee6$(_context6) {\n      while (1) {\n        switch (_context6.prev = _context6.next) {\n          case 0:\n            if (iframe.instance) {\n              _context6.next = 2;\n              break;\n            }\n\n            throw _constants.ERRORS.TypedError('Init_NotInitialized');\n\n          case 2:\n            if (!(typeof params.callback === 'function')) {\n              _context6.next = 11;\n              break;\n            }\n\n            callback = params.callback; // TODO: set message listener only if iframe is loaded correctly\n\n            loginChallengeListener = /*#__PURE__*/function () {\n              var _ref6 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee5(event) {\n                var data, payload;\n                return _regenerator[\"default\"].wrap(function _callee5$(_context5) {\n                  while (1) {\n                    switch (_context5.prev = _context5.next) {\n                      case 0:\n                        data = event.data;\n\n                        if (!(data && data.type === _constants.UI.LOGIN_CHALLENGE_REQUEST)) {\n                          _context5.next = 12;\n                          break;\n                        }\n\n                        _context5.prev = 2;\n                        _context5.next = 5;\n                        return callback();\n\n                      case 5:\n                        payload = _context5.sent;\n                        iframe.postMessage({\n                          event: _constants.UI_EVENT,\n                          type: _constants.UI.LOGIN_CHALLENGE_RESPONSE,\n                          payload: payload\n                        });\n                        _context5.next = 12;\n                        break;\n\n                      case 9:\n                        _context5.prev = 9;\n                        _context5.t0 = _context5[\"catch\"](2);\n                        iframe.postMessage({\n                          event: _constants.UI_EVENT,\n                          type: _constants.UI.LOGIN_CHALLENGE_RESPONSE,\n                          payload: _context5.t0.message\n                        });\n\n                      case 12:\n                      case \"end\":\n                        return _context5.stop();\n                    }\n                  }\n                }, _callee5, null, [[2, 9]]);\n              }));\n\n              return function loginChallengeListener(_x6) {\n                return _ref6.apply(this, arguments);\n              };\n            }();\n\n            window.addEventListener('message', loginChallengeListener, false);\n            _context6.next = 8;\n            return call(_objectSpread(_objectSpread({\n              method: 'requestLogin'\n            }, params), {}, {\n              asyncChallenge: true,\n              callback: null\n            }));\n\n          case 8:\n            response = _context6.sent;\n            window.removeEventListener('message', loginChallengeListener);\n            return _context6.abrupt(\"return\", response);\n\n          case 11:\n            return _context6.abrupt(\"return\", call(_objectSpread({\n              method: 'requestLogin'\n            }, params)));\n\n          case 12:\n          case \"end\":\n            return _context6.stop();\n        }\n      }\n    }, _callee6);\n  }));\n\n  return function requestLogin(_x5) {\n    return _ref5.apply(this, arguments);\n  };\n}();\n\nexports.requestLogin = requestLogin;\n\nvar disableWebUSB = function disableWebUSB() {\n  if (!iframe.instance) {\n    throw _constants.ERRORS.TypedError('Init_NotInitialized');\n  }\n\n  iframe.postMessage({\n    event: _constants.UI_EVENT,\n    type: _constants.TRANSPORT.DISABLE_WEBUSB\n  });\n};\n\nexports.disableWebUSB = disableWebUSB;","map":{"version":3,"sources":["/Users/massimilianoalbini/Documents/gain-drop/node_modules/trezor-connect/lib/env/browser/index.js"],"names":["_interopRequireDefault","require","exports","__esModule","disableWebUSB","requestLogin","customMessage","getSettings","renderWebUSBButton","uiResponse","call","init","cancel","dispose","manifest","eventEmitter","_regenerator","_asyncToGenerator2","_defineProperty2","_events","_PopupManager","iframe","_interopRequireWildcard","_button","_message","_builder2","_ConnectSettings","_debug","_constants","$T","_getRequireWildcardCache","nodeInterop","WeakMap","cacheBabelInterop","cacheNodeInterop","obj","cache","has","get","newObj","hasPropertyDescriptor","Object","defineProperty","getOwnPropertyDescriptor","key","prototype","hasOwnProperty","desc","set","ownKeys","object","enumerableOnly","keys","getOwnPropertySymbols","symbols","filter","sym","enumerable","push","apply","_objectSpread","target","i","arguments","length","source","forEach","getOwnPropertyDescriptors","defineProperties","_log","initLog","_settings","parse","_popupManager","initPopupManager","pm","on","POPUP","CLOSED","error","postMessage","type","payload","data","removeAllListeners","close","emit","handleMessage","messageEvent","origin","message","parseMessage","event","id","log","RESPONSE_EVENT","messagePromises","resolve","success","warn","DEVICE_EVENT","TRANSPORT_EVENT","BLOCKCHAIN_EVENT","UI_EVENT","IFRAME","BOOTSTRAP","clearTimeout","LOADED","initPromise","ERROR","reject","_ref","mark","_callee","settings","wrap","_callee$","_context","prev","next","instance","ERRORS","TypedError","lazyLoad","abrupt","enabled","debug","window","addEventListener","stop","_x","_ref2","_callee2","params","response","_callee2$","_context2","timeout","errorMessage","request","t0","includes","code","UiMessage","UI","IFRAME_FAILURE","popup","CALL","sent","unlock","t1","_x2","customMessageResponse","CUSTOM_MESSAGE_RESPONSE","className","webusbSrc","Promise","method","_ref3","_callee4","callback","customMessageListener","_callee4$","_context4","_ref4","_callee3","_callee3$","_context3","CUSTOM_MESSAGE_REQUEST","_x4","removeEventListener","_x3","_ref5","_callee6","loginChallengeListener","_callee6$","_context6","_ref6","_callee5","_callee5$","_context5","LOGIN_CHALLENGE_REQUEST","LOGIN_CHALLENGE_RESPONSE","_x6","asyncChallenge","_x5","TRANSPORT","DISABLE_WEBUSB"],"mappings":"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","sourcesContent":["\"use strict\";\n\nvar _interopRequireDefault = require(\"@babel/runtime/helpers/interopRequireDefault\");\n\nexports.__esModule = true;\nexports.disableWebUSB = exports.requestLogin = exports.customMessage = exports.getSettings = exports.renderWebUSBButton = exports.uiResponse = exports.call = exports.init = exports.cancel = exports.dispose = exports.manifest = exports.eventEmitter = void 0;\n\nvar _regenerator = _interopRequireDefault(require(\"@babel/runtime/regenerator\"));\n\nvar _asyncToGenerator2 = _interopRequireDefault(require(\"@babel/runtime/helpers/asyncToGenerator\"));\n\nvar _defineProperty2 = _interopRequireDefault(require(\"@babel/runtime/helpers/defineProperty\"));\n\nvar _events = _interopRequireDefault(require(\"events\"));\n\nvar _PopupManager = _interopRequireDefault(require(\"../../popup/PopupManager\"));\n\nvar iframe = _interopRequireWildcard(require(\"../../iframe/builder\"));\n\nvar _button = _interopRequireDefault(require(\"../../webusb/button\"));\n\nvar _message = require(\"../../message\");\n\nvar _builder2 = require(\"../../message/builder\");\n\nvar _ConnectSettings = require(\"../../data/ConnectSettings\");\n\nvar _debug = require(\"../../utils/debug\");\n\nvar _constants = require(\"../../constants\");\n\nvar $T = _interopRequireWildcard(require(\"../../types\"));\n\nfunction _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== \"function\") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }\n\nfunction _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== \"object\" && typeof obj !== \"function\") { return { \"default\": obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== \"default\" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj[\"default\"] = obj; if (cache) { cache.set(obj, newObj); } return newObj; }\n\nfunction ownKeys(object, enumerableOnly) { var keys = Object.keys(object); if (Object.getOwnPropertySymbols) { var symbols = Object.getOwnPropertySymbols(object); if (enumerableOnly) { symbols = symbols.filter(function (sym) { return Object.getOwnPropertyDescriptor(object, sym).enumerable; }); } keys.push.apply(keys, symbols); } return keys; }\n\nfunction _objectSpread(target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i] != null ? arguments[i] : {}; if (i % 2) { ownKeys(Object(source), true).forEach(function (key) { (0, _defineProperty2[\"default\"])(target, key, source[key]); }); } else if (Object.getOwnPropertyDescriptors) { Object.defineProperties(target, Object.getOwnPropertyDescriptors(source)); } else { ownKeys(Object(source)).forEach(function (key) { Object.defineProperty(target, key, Object.getOwnPropertyDescriptor(source, key)); }); } } return target; }\n\nvar eventEmitter = new _events[\"default\"]();\nexports.eventEmitter = eventEmitter;\n\nvar _log = (0, _debug.initLog)('[trezor-connect.js]');\n\nvar _settings = (0, _ConnectSettings.parse)();\n\nvar _popupManager;\n\nvar initPopupManager = function initPopupManager() {\n  var pm = new _PopupManager[\"default\"](_settings);\n  pm.on(_constants.POPUP.CLOSED, function (error) {\n    iframe.postMessage({\n      type: _constants.POPUP.CLOSED,\n      payload: error ? {\n        error: error\n      } : null\n    }, false);\n  });\n  return pm;\n};\n\nvar manifest = function manifest(data) {\n  _settings = (0, _ConnectSettings.parse)(_objectSpread(_objectSpread({}, _settings), {}, {\n    manifest: data\n  }));\n};\n\nexports.manifest = manifest;\n\nvar dispose = function dispose() {\n  eventEmitter.removeAllListeners();\n  iframe.dispose();\n  _settings = (0, _ConnectSettings.parse)();\n\n  if (_popupManager) {\n    _popupManager.close();\n  }\n};\n\nexports.dispose = dispose;\n\nvar cancel = function cancel(error) {\n  if (_popupManager) {\n    _popupManager.emit(_constants.POPUP.CLOSED, error);\n  }\n}; // handle message received from iframe\n\n\nexports.cancel = cancel;\n\nvar handleMessage = function handleMessage(messageEvent) {\n  // ignore messages from domain other then iframe origin\n  if (messageEvent.origin !== iframe.origin) return;\n  var message = (0, _message.parseMessage)(messageEvent.data);\n  var event = message.event,\n      type = message.type,\n      payload = message.payload;\n  var id = message.id || 0;\n\n  _log.log('handleMessage', message);\n\n  switch (event) {\n    case _constants.RESPONSE_EVENT:\n      if (iframe.messagePromises[id]) {\n        // resolve message promise (send result of call method)\n        iframe.messagePromises[id].resolve({\n          id: id,\n          success: message.success,\n          payload: payload\n        });\n        delete iframe.messagePromises[id];\n      } else {\n        _log.warn(\"Unknown message id \" + id);\n      }\n\n      break;\n\n    case _constants.DEVICE_EVENT:\n      // pass DEVICE event up to html\n      eventEmitter.emit(event, message);\n      eventEmitter.emit(type, payload); // DEVICE_EVENT also emit single events (connect/disconnect...)\n\n      break;\n\n    case _constants.TRANSPORT_EVENT:\n      eventEmitter.emit(event, message);\n      eventEmitter.emit(type, payload);\n      break;\n\n    case _constants.BLOCKCHAIN_EVENT:\n      eventEmitter.emit(event, message);\n      eventEmitter.emit(type, payload);\n      break;\n\n    case _constants.UI_EVENT:\n      if (type === _constants.IFRAME.BOOTSTRAP) {\n        iframe.clearTimeout();\n        break;\n      }\n\n      if (type === _constants.IFRAME.LOADED) {\n        iframe.initPromise.resolve();\n      }\n\n      if (type === _constants.IFRAME.ERROR) {\n        iframe.initPromise.reject(payload.error);\n      } // pass UI event up\n\n\n      eventEmitter.emit(event, message);\n      eventEmitter.emit(type, payload);\n      break;\n\n    default:\n      _log.log('Undefined message', event, messageEvent);\n\n  }\n};\n\nvar init = /*#__PURE__*/function () {\n  var _ref = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee(settings) {\n    return _regenerator[\"default\"].wrap(function _callee$(_context) {\n      while (1) {\n        switch (_context.prev = _context.next) {\n          case 0:\n            if (settings === void 0) {\n              settings = {};\n            }\n\n            if (!iframe.instance) {\n              _context.next = 3;\n              break;\n            }\n\n            throw _constants.ERRORS.TypedError('Init_AlreadyInitialized');\n\n          case 3:\n            _settings = (0, _ConnectSettings.parse)(_objectSpread(_objectSpread({}, _settings), settings));\n\n            if (_settings.manifest) {\n              _context.next = 6;\n              break;\n            }\n\n            throw _constants.ERRORS.TypedError('Init_ManifestMissing');\n\n          case 6:\n            if (!_settings.lazyLoad) {\n              _context.next = 9;\n              break;\n            }\n\n            // reset \"lazyLoad\" after first use\n            _settings.lazyLoad = false;\n            return _context.abrupt(\"return\");\n\n          case 9:\n            if (!_popupManager) {\n              _popupManager = initPopupManager();\n            }\n\n            _log.enabled = !!_settings.debug;\n            window.addEventListener('message', handleMessage);\n            window.addEventListener('unload', dispose);\n            _context.next = 15;\n            return iframe.init(_settings);\n\n          case 15:\n          case \"end\":\n            return _context.stop();\n        }\n      }\n    }, _callee);\n  }));\n\n  return function init(_x) {\n    return _ref.apply(this, arguments);\n  };\n}();\n\nexports.init = init;\n\nvar call = /*#__PURE__*/function () {\n  var _ref2 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee2(params) {\n    var response;\n    return _regenerator[\"default\"].wrap(function _callee2$(_context2) {\n      while (1) {\n        switch (_context2.prev = _context2.next) {\n          case 0:\n            if (!(!iframe.instance && !iframe.timeout)) {\n              _context2.next = 15;\n              break;\n            }\n\n            // init popup with lazy loading before iframe initialization\n            _settings = (0, _ConnectSettings.parse)(_settings);\n\n            if (_settings.manifest) {\n              _context2.next = 4;\n              break;\n            }\n\n            return _context2.abrupt(\"return\", (0, _message.errorMessage)(_constants.ERRORS.TypedError('Init_ManifestMissing')));\n\n          case 4:\n            if (!_popupManager) {\n              _popupManager = initPopupManager();\n            }\n\n            _popupManager.request(true); // auto init with default settings\n\n\n            _context2.prev = 6;\n            _context2.next = 9;\n            return init(_settings);\n\n          case 9:\n            _context2.next = 15;\n            break;\n\n          case 11:\n            _context2.prev = 11;\n            _context2.t0 = _context2[\"catch\"](6);\n\n            if (_popupManager) {\n              // Catch fatal iframe errors (not loading)\n              if (['Init_IframeBlocked', 'Init_IframeTimeout'].includes(_context2.t0.code)) {\n                _popupManager.postMessage((0, _builder2.UiMessage)(_constants.UI.IFRAME_FAILURE));\n              } else {\n                _popupManager.close();\n              }\n            }\n\n            return _context2.abrupt(\"return\", (0, _message.errorMessage)(_context2.t0));\n\n          case 15:\n            if (!iframe.timeout) {\n              _context2.next = 17;\n              break;\n            }\n\n            return _context2.abrupt(\"return\", (0, _message.errorMessage)(_constants.ERRORS.TypedError('Init_ManifestMissing')));\n\n          case 17:\n            if (!iframe.error) {\n              _context2.next = 19;\n              break;\n            }\n\n            return _context2.abrupt(\"return\", (0, _message.errorMessage)(iframe.error));\n\n          case 19:\n            // request popup window it might be used in the future\n            if (_settings.popup && _popupManager) {\n              _popupManager.request();\n            } // post message to iframe\n\n\n            _context2.prev = 20;\n            _context2.next = 23;\n            return iframe.postMessage({\n              type: _constants.IFRAME.CALL,\n              payload: params\n            });\n\n          case 23:\n            response = _context2.sent;\n\n            if (!response) {\n              _context2.next = 27;\n              break;\n            }\n\n            if (!response.success && response.payload.code !== 'Device_CallInProgress' && _popupManager) {\n              _popupManager.unlock();\n            }\n\n            return _context2.abrupt(\"return\", response);\n\n          case 27:\n            if (_popupManager) {\n              _popupManager.unlock();\n            }\n\n            return _context2.abrupt(\"return\", (0, _message.errorMessage)(_constants.ERRORS.TypedError('Method_NoResponse')));\n\n          case 31:\n            _context2.prev = 31;\n            _context2.t1 = _context2[\"catch\"](20);\n\n            _log.error('__call error', _context2.t1);\n\n            if (_popupManager) {\n              _popupManager.close();\n            }\n\n            return _context2.abrupt(\"return\", (0, _message.errorMessage)(_context2.t1));\n\n          case 36:\n          case \"end\":\n            return _context2.stop();\n        }\n      }\n    }, _callee2, null, [[6, 11], [20, 31]]);\n  }));\n\n  return function call(_x2) {\n    return _ref2.apply(this, arguments);\n  };\n}();\n\nexports.call = call;\n\nvar customMessageResponse = function customMessageResponse(payload) {\n  iframe.postMessage({\n    event: _constants.UI_EVENT,\n    type: _constants.UI.CUSTOM_MESSAGE_RESPONSE,\n    payload: payload\n  });\n};\n\nvar uiResponse = function uiResponse(response) {\n  if (!iframe.instance) {\n    throw _constants.ERRORS.TypedError('Init_NotInitialized');\n  }\n\n  var type = response.type,\n      payload = response.payload;\n  iframe.postMessage({\n    event: _constants.UI_EVENT,\n    type: type,\n    payload: payload\n  });\n};\n\nexports.uiResponse = uiResponse;\n\nvar renderWebUSBButton = function renderWebUSBButton(className) {\n  (0, _button[\"default\"])(className, _settings.webusbSrc, iframe.origin);\n};\n\nexports.renderWebUSBButton = renderWebUSBButton;\n\nvar getSettings = function getSettings() {\n  if (!iframe.instance) {\n    return Promise.resolve((0, _message.errorMessage)(_constants.ERRORS.TypedError('Init_NotInitialized')));\n  }\n\n  return call({\n    method: 'getSettings'\n  });\n};\n\nexports.getSettings = getSettings;\n\nvar customMessage = /*#__PURE__*/function () {\n  var _ref3 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee4(params) {\n    var callback, customMessageListener, response;\n    return _regenerator[\"default\"].wrap(function _callee4$(_context4) {\n      while (1) {\n        switch (_context4.prev = _context4.next) {\n          case 0:\n            if (iframe.instance) {\n              _context4.next = 2;\n              break;\n            }\n\n            throw _constants.ERRORS.TypedError('Init_NotInitialized');\n\n          case 2:\n            if (!(typeof params.callback !== 'function')) {\n              _context4.next = 4;\n              break;\n            }\n\n            return _context4.abrupt(\"return\", (0, _message.errorMessage)(_constants.ERRORS.TypedError('Method_CustomMessage_Callback')));\n\n          case 4:\n            // TODO: set message listener only if iframe is loaded correctly\n            callback = params.callback;\n\n            customMessageListener = /*#__PURE__*/function () {\n              var _ref4 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee3(event) {\n                var data, payload;\n                return _regenerator[\"default\"].wrap(function _callee3$(_context3) {\n                  while (1) {\n                    switch (_context3.prev = _context3.next) {\n                      case 0:\n                        data = event.data;\n\n                        if (!(data && data.type === _constants.UI.CUSTOM_MESSAGE_REQUEST)) {\n                          _context3.next = 6;\n                          break;\n                        }\n\n                        _context3.next = 4;\n                        return callback(data.payload);\n\n                      case 4:\n                        payload = _context3.sent;\n\n                        if (payload) {\n                          customMessageResponse(payload);\n                        } else {\n                          customMessageResponse({\n                            message: 'release'\n                          });\n                        }\n\n                      case 6:\n                      case \"end\":\n                        return _context3.stop();\n                    }\n                  }\n                }, _callee3);\n              }));\n\n              return function customMessageListener(_x4) {\n                return _ref4.apply(this, arguments);\n              };\n            }();\n\n            window.addEventListener('message', customMessageListener, false);\n            _context4.next = 9;\n            return call(_objectSpread(_objectSpread({\n              method: 'customMessage'\n            }, params), {}, {\n              callback: null\n            }));\n\n          case 9:\n            response = _context4.sent;\n            window.removeEventListener('message', customMessageListener);\n            return _context4.abrupt(\"return\", response);\n\n          case 12:\n          case \"end\":\n            return _context4.stop();\n        }\n      }\n    }, _callee4);\n  }));\n\n  return function customMessage(_x3) {\n    return _ref3.apply(this, arguments);\n  };\n}();\n\nexports.customMessage = customMessage;\n\nvar requestLogin = /*#__PURE__*/function () {\n  var _ref5 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee6(params) {\n    var callback, loginChallengeListener, response;\n    return _regenerator[\"default\"].wrap(function _callee6$(_context6) {\n      while (1) {\n        switch (_context6.prev = _context6.next) {\n          case 0:\n            if (iframe.instance) {\n              _context6.next = 2;\n              break;\n            }\n\n            throw _constants.ERRORS.TypedError('Init_NotInitialized');\n\n          case 2:\n            if (!(typeof params.callback === 'function')) {\n              _context6.next = 11;\n              break;\n            }\n\n            callback = params.callback; // TODO: set message listener only if iframe is loaded correctly\n\n            loginChallengeListener = /*#__PURE__*/function () {\n              var _ref6 = (0, _asyncToGenerator2[\"default\"])( /*#__PURE__*/_regenerator[\"default\"].mark(function _callee5(event) {\n                var data, payload;\n                return _regenerator[\"default\"].wrap(function _callee5$(_context5) {\n                  while (1) {\n                    switch (_context5.prev = _context5.next) {\n                      case 0:\n                        data = event.data;\n\n                        if (!(data && data.type === _constants.UI.LOGIN_CHALLENGE_REQUEST)) {\n                          _context5.next = 12;\n                          break;\n                        }\n\n                        _context5.prev = 2;\n                        _context5.next = 5;\n                        return callback();\n\n                      case 5:\n                        payload = _context5.sent;\n                        iframe.postMessage({\n                          event: _constants.UI_EVENT,\n                          type: _constants.UI.LOGIN_CHALLENGE_RESPONSE,\n                          payload: payload\n                        });\n                        _context5.next = 12;\n                        break;\n\n                      case 9:\n                        _context5.prev = 9;\n                        _context5.t0 = _context5[\"catch\"](2);\n                        iframe.postMessage({\n                          event: _constants.UI_EVENT,\n                          type: _constants.UI.LOGIN_CHALLENGE_RESPONSE,\n                          payload: _context5.t0.message\n                        });\n\n                      case 12:\n                      case \"end\":\n                        return _context5.stop();\n                    }\n                  }\n                }, _callee5, null, [[2, 9]]);\n              }));\n\n              return function loginChallengeListener(_x6) {\n                return _ref6.apply(this, arguments);\n              };\n            }();\n\n            window.addEventListener('message', loginChallengeListener, false);\n            _context6.next = 8;\n            return call(_objectSpread(_objectSpread({\n              method: 'requestLogin'\n            }, params), {}, {\n              asyncChallenge: true,\n              callback: null\n            }));\n\n          case 8:\n            response = _context6.sent;\n            window.removeEventListener('message', loginChallengeListener);\n            return _context6.abrupt(\"return\", response);\n\n          case 11:\n            return _context6.abrupt(\"return\", call(_objectSpread({\n              method: 'requestLogin'\n            }, params)));\n\n          case 12:\n          case \"end\":\n            return _context6.stop();\n        }\n      }\n    }, _callee6);\n  }));\n\n  return function requestLogin(_x5) {\n    return _ref5.apply(this, arguments);\n  };\n}();\n\nexports.requestLogin = requestLogin;\n\nvar disableWebUSB = function disableWebUSB() {\n  if (!iframe.instance) {\n    throw _constants.ERRORS.TypedError('Init_NotInitialized');\n  }\n\n  iframe.postMessage({\n    event: _constants.UI_EVENT,\n    type: _constants.TRANSPORT.DISABLE_WEBUSB\n  });\n};\n\nexports.disableWebUSB = disableWebUSB;"]},"metadata":{},"sourceType":"script"}