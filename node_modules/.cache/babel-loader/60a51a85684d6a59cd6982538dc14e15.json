{"ast":null,"code":"\"use strict\";\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  Object.defineProperty(o, k2, {\n    enumerable: true,\n    get: function () {\n      return m[k];\n    }\n  });\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\n\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\n\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n\n  __setModuleDefault(result, mod);\n\n  return result;\n};\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.Adapter = void 0;\n\nconst core = __importStar(require(\"@shapeshiftoss/hdwallet-core\"));\n\nconst keepkey_1 = require(\"./keepkey\");\n\nconst transport_1 = require(\"./transport\");\n\nclass Adapter {\n  constructor(keyring, delegate) {\n    var _a, _b;\n\n    this.keyring = keyring;\n    this.delegate = delegate;\n\n    try {\n      (_b = (_a = this.delegate).registerCallbacks) === null || _b === void 0 ? void 0 : _b.call(_a, this.handleConnect.bind(this), this.handleDisconnect.bind(this));\n    } catch (e) {\n      console.error(e);\n    }\n  }\n\n  static fromDelegate(delegate) {\n    const fn = keyring => new Adapter(keyring, delegate);\n\n    const out = fn;\n    out.useKeyring = fn;\n    return out;\n  }\n\n  static inspectDevice(delegate, device) {\n    var _a, _b;\n\n    return __awaiter(this, void 0, void 0, function* () {\n      const props = (_b = yield Promise.resolve((_a = delegate.inspectDevice) === null || _a === void 0 ? void 0 : _a.call(delegate, device))) !== null && _b !== void 0 ? _b : [\"object\", \"function\"].includes(typeof device) ? device : {};\n      if (!props.serialNumber && typeof device === \"string\") props.serialNumber = device;\n      return {\n        get productName() {\n          const out = props[\"productName\"];\n          return typeof out === \"string\" ? out : \"KeepKey\";\n        },\n\n        get serialNumber() {\n          const out = props[\"serialNumber\"];\n          if (typeof out !== \"string\") throw new Error(\"could not get serialNumber from device\");\n          return out;\n        }\n\n      };\n    });\n  }\n\n  inspectDevice(device) {\n    return __awaiter(this, void 0, void 0, function* () {\n      return Adapter.inspectDevice(this.delegate, device);\n    });\n  }\n\n  handleConnect(device) {\n    return __awaiter(this, void 0, void 0, function* () {\n      try {\n        yield this.initialize([device]);\n        const {\n          productName,\n          serialNumber\n        } = yield this.inspectDevice(device);\n        yield this.keyring.emit([productName, serialNumber, core.Events.CONNECT], serialNumber);\n      } catch (e) {\n        console.error(e);\n      }\n    });\n  }\n\n  handleDisconnect(device) {\n    return __awaiter(this, void 0, void 0, function* () {\n      const {\n        productName,\n        serialNumber\n      } = yield this.inspectDevice(device);\n\n      try {\n        yield this.keyring.remove(serialNumber);\n      } catch (_a) {}\n\n      yield this.keyring.emit([productName, serialNumber, core.Events.DISCONNECT], serialNumber);\n    });\n  }\n\n  initialize(devices, tryDebugLink, autoConnect) {\n    return __awaiter(this, void 0, void 0, function* () {\n      devices = devices !== null && devices !== void 0 ? devices : yield this.getDevices();\n\n      for (const device of devices) {\n        const {\n          serialNumber\n        } = yield this.inspectDevice(device);\n        if (this.keyring.wallets[serialNumber]) yield this.keyring.remove(serialNumber);\n        const delegate = yield this.getTransportDelegate(device);\n        if (delegate === null) continue;\n        const transport = yield transport_1.Transport.create(this.keyring, delegate);\n        yield transport.connect();\n        if (tryDebugLink) yield transport.tryConnectDebugLink();\n        const wallet = yield keepkey_1.KeepKeyHDWallet.create(transport);\n        if (autoConnect) yield wallet.initialize();\n        this.keyring.add(wallet, serialNumber);\n      }\n\n      return Object.keys(this.keyring.wallets).length;\n    });\n  }\n\n  getDevice(serialNumber) {\n    return __awaiter(this, void 0, void 0, function* () {\n      if (this.delegate.getDevice) return yield this.delegate.getDevice(serialNumber);\n      if (!serialNumber) throw new Error(\"no default device specified\");\n      const devices = yield this.getDevices();\n      return (yield Promise.all(devices.map(x => __awaiter(this, void 0, void 0, function* () {\n        return (yield this.inspectDevice(x)).serialNumber === serialNumber ? x : null;\n      })))).filter(x => x !== null)[0];\n    });\n  }\n\n  getDevices() {\n    return __awaiter(this, void 0, void 0, function* () {\n      if (this.delegate.getDevices) return yield this.delegate.getDevices();\n      let defaultDevice = undefined;\n\n      try {\n        defaultDevice = yield this.getDevice();\n      } catch (_a) {}\n\n      return defaultDevice ? [defaultDevice] : [];\n    });\n  }\n\n  getTransportDelegate(device) {\n    return __awaiter(this, void 0, void 0, function* () {\n      return yield this.delegate.getTransportDelegate(device);\n    });\n  }\n\n  pairDevice(serialNumber, tryDebugLink) {\n    return __awaiter(this, void 0, void 0, function* () {\n      const device = yield this.getDevice(serialNumber);\n      if (!device) throw new Error(serialNumber ? `could not find device matching serial number '${serialNumber}'` : \"could not find default device\");\n      return this.pairRawDevice(device, tryDebugLink);\n    });\n  }\n\n  pairRawDevice(device, tryDebugLink) {\n    return __awaiter(this, void 0, void 0, function* () {\n      yield this.initialize([device], tryDebugLink, true);\n      return core.mustBeDefined(this.keyring.get((yield this.inspectDevice(device)).serialNumber));\n    });\n  }\n\n}\n\nexports.Adapter = Adapter;","map":{"version":3,"mappings":"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","names":["Adapter","constructor","keyring","delegate","registerCallbacks","_b","handleConnect","bind","handleDisconnect","e","console","error","fromDelegate","fn","out","useKeyring","inspectDevice","device","props","Promise","resolve","_a","includes","serialNumber","productName","Error","initialize","emit","core","Events","CONNECT","remove","DISCONNECT","devices","tryDebugLink","autoConnect","getDevices","wallets","getTransportDelegate","transport","transport_1","create","connect","tryConnectDebugLink","wallet","keepkey_1","add","Object","keys","length","getDevice","all","map","x","__awaiter","filter","defaultDevice","undefined","pairDevice","pairRawDevice","mustBeDefined","get","exports"],"sourceRoot":"","sources":["../src/adapter.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}