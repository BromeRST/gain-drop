{"ast":null,"code":"\"use strict\";\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  Object.defineProperty(o, k2, {\n    enumerable: true,\n    get: function () {\n      return m[k];\n    }\n  });\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\n\nvar __exportStar = this && this.__exportStar || function (m, exports) {\n  for (var p in m) if (p !== \"default\" && !Object.prototype.hasOwnProperty.call(exports, p)) __createBinding(exports, m, p);\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nconst messageFormatter_1 = require(\"./messageFormatter\");\n\nclass PostMessageCommunicator {\n  constructor() {\n    let allowedOrigins = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : null;\n    let debugMode = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : false;\n    this.allowedOrigins = null;\n    this.callbacks = new Map();\n    this.debugMode = false;\n\n    this.isValidMessage = _ref => {\n      let {\n        origin,\n        data,\n        source\n      } = _ref;\n      const emptyOrMalformed = !data;\n      const sentFromParentEl = source === window.parent;\n      const majorVersionNumber = typeof data.version !== 'undefined' && parseInt(data.version.split('.')[0]);\n      const allowedSDKVersion = majorVersionNumber >= 1;\n      let validOrigin = true;\n\n      if (Array.isArray(this.allowedOrigins)) {\n        validOrigin = this.allowedOrigins.find(regExp => regExp.test(origin)) !== undefined;\n      }\n\n      return !emptyOrMalformed && sentFromParentEl && allowedSDKVersion && validOrigin;\n    };\n\n    this.logIncomingMessage = msg => {\n      console.info(`Safe Apps SDK v1: A message was received from origin ${msg.origin}. `, msg.data);\n    };\n\n    this.onParentMessage = msg => {\n      if (this.isValidMessage(msg)) {\n        this.debugMode && this.logIncomingMessage(msg);\n        this.handleIncomingMessage(msg.data);\n      }\n    };\n\n    this.handleIncomingMessage = payload => {\n      const {\n        id\n      } = payload;\n      const cb = this.callbacks.get(id);\n\n      if (cb) {\n        cb(payload);\n        this.callbacks.delete(id);\n      }\n    };\n\n    this.send = (method, params) => {\n      const request = messageFormatter_1.MessageFormatter.makeRequest(method, params);\n\n      if (typeof window === 'undefined') {\n        throw new Error(\"Window doesn't exist\");\n      }\n\n      window.parent.postMessage(request, '*');\n      return new Promise((resolve, reject) => {\n        this.callbacks.set(request.id, response => {\n          if (!response.success) {\n            reject(new Error(response.error));\n            return;\n          }\n\n          resolve(response);\n        });\n      });\n    };\n\n    this.allowedOrigins = allowedOrigins;\n    this.debugMode = debugMode;\n    window.addEventListener('message', this.onParentMessage);\n  }\n\n}\n\nexports.default = PostMessageCommunicator;\n\n__exportStar(require(\"./methods\"), exports);","map":{"version":3,"mappings":"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","names":["PostMessageCommunicator","constructor","allowedOrigins","debugMode","Map","origin","data","source","emptyOrMalformed","sentFromParentEl","window","parent","majorVersionNumber","version","parseInt","split","allowedSDKVersion","validOrigin","Array","isArray","find","regExp","test","undefined","msg","console","info","isValidMessage","logIncomingMessage","handleIncomingMessage","payload","id","cb","callbacks","get","delete","method","params","request","messageFormatter_1","makeRequest","Error","postMessage","Promise","resolve","reject","set","response","success","error","addEventListener","onParentMessage","exports","__exportStar"],"sourceRoot":"","sources":["../../../src/communication/index.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}