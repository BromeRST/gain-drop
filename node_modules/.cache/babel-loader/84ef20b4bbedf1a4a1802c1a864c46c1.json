{"ast":null,"code":"\"use strict\";\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  Object.defineProperty(o, k2, {\n    enumerable: true,\n    get: function () {\n      return m[k];\n    }\n  });\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\n\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\n\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n\n  __setModuleDefault(result, mod);\n\n  return result;\n};\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.Keyring = void 0;\n\nconst eventemitter2 = __importStar(require(\"eventemitter2\"));\n\nclass Keyring extends eventemitter2.EventEmitter2 {\n  constructor() {\n    super({\n      wildcard: true\n    });\n    this.wallets = {};\n    this.aliases = {};\n  }\n\n  add(wallet, deviceID) {\n    const id = deviceID || new Date().toString();\n\n    if (!this.wallets[id]) {\n      this.wallets[id] = wallet;\n      wallet.transport && this.decorateEvents(id, wallet.transport);\n      return true;\n    }\n\n    return false;\n  }\n\n  addAlias(aliasee, alias) {\n    this.aliases[alias] = aliasee;\n  }\n\n  getAlias(aliasee) {\n    const keys = Object.keys(this.aliases);\n    const values = Object.values(this.aliases);\n    const index = values.indexOf(aliasee);\n    if (index !== -1) return keys[index];\n    return aliasee;\n  }\n\n  exec(method) {\n    for (var _len = arguments.length, args = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {\n      args[_key - 1] = arguments[_key];\n    }\n\n    return __awaiter(this, void 0, void 0, function* () {\n      return Promise.all(Object.values(this.wallets).map(w => {\n        const fn = w[method];\n        if (typeof fn !== \"function\") throw new Error(`can't exec non-existent method ${method}`);\n        return fn.call(w, ...args);\n      })).then(values => values.reduce((final, response, i) => {\n        final[Object.keys(this.wallets)[i]] = response;\n        return final;\n      }, {}));\n    });\n  }\n\n  get(deviceID) {\n    if (deviceID && this.aliases[deviceID] && this.wallets[this.aliases[deviceID]]) return this.wallets[this.aliases[deviceID]];\n    if (deviceID && this.wallets[deviceID]) return this.wallets[deviceID];\n    if (!!Object.keys(this.wallets).length && !deviceID) return Object.values(this.wallets)[0];\n    return null;\n  }\n\n  remove(deviceID) {\n    return __awaiter(this, void 0, void 0, function* () {\n      const wallet = this.get(deviceID);\n      if (!wallet) return;\n\n      try {\n        yield wallet.disconnect();\n      } catch (e) {\n        console.error(e);\n      } finally {\n        let aliasee = this.aliases[deviceID];\n\n        if (aliasee) {\n          delete this.aliases[deviceID];\n          delete this.wallets[aliasee];\n        } else {\n          delete this.wallets[deviceID];\n        }\n      }\n    });\n  }\n\n  removeAll() {\n    return __awaiter(this, void 0, void 0, function* () {\n      yield Promise.all(Object.keys(this.wallets).map(this.remove.bind(this)));\n      this.aliases = {};\n    });\n  }\n\n  disconnectAll() {\n    return __awaiter(this, void 0, void 0, function* () {\n      const wallets = Object.values(this.wallets);\n\n      for (let i = 0; i < wallets.length; i++) {\n        yield wallets[i].disconnect();\n      }\n    });\n  }\n\n  decorateEvents(deviceID, events) {\n    var _this = this;\n\n    const wallet = this.get(deviceID);\n    if (!wallet) return;\n    const vendor = wallet.getVendor();\n    events.onAny(function (e) {\n      for (var _len2 = arguments.length, values = new Array(_len2 > 1 ? _len2 - 1 : 0), _key2 = 1; _key2 < _len2; _key2++) {\n        values[_key2 - 1] = arguments[_key2];\n      }\n\n      return _this.emit([vendor, deviceID, typeof e === \"string\" ? e : e.join(\";\")], [deviceID, ...values]);\n    });\n  }\n\n}\n\nexports.Keyring = Keyring;","map":{"version":3,"mappings":"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","names":["Keyring","eventemitter2","EventEmitter2","constructor","wildcard","add","wallet","deviceID","id","Date","toString","wallets","transport","decorateEvents","addAlias","aliasee","alias","aliases","getAlias","keys","Object","values","index","indexOf","exec","method","args","Promise","all","map","w","fn","Error","call","then","reduce","final","response","i","get","length","remove","disconnect","e","console","error","removeAll","bind","disconnectAll","events","vendor","getVendor","onAny","emit","join","exports"],"sourceRoot":"","sources":["../src/keyring.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}