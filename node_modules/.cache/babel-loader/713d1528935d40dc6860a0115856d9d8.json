{"ast":null,"code":"\"use strict\";\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  Object.defineProperty(o, k2, {\n    enumerable: true,\n    get: function () {\n      return m[k];\n    }\n  });\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\n\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\n\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n\n  __setModuleDefault(result, mod);\n\n  return result;\n};\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.Transport = void 0;\n\nconst Messages = __importStar(require(\"@keepkey/device-protocol/lib/messages_pb\"));\n\nconst Types = __importStar(require(\"@keepkey/device-protocol/lib/types_pb\"));\n\nconst core = __importStar(require(\"@shapeshiftoss/hdwallet-core\"));\n\nconst jspb = __importStar(require(\"google-protobuf\"));\n\nconst responseTypeRegistry_1 = require(\"./responseTypeRegistry\");\n\nconst typeRegistry_1 = require(\"./typeRegistry\");\n\nconst utils_1 = require(\"./utils\");\n\nclass Transport extends core.Transport {\n  constructor(keyring, delegate) {\n    super(keyring);\n    this.debugLink = false;\n    this.userActionRequired = false; /// One per transport, unlike on Trezor, since the contention is\n    /// only per-device, not global.\n\n    this.callInProgress = {\n      main: undefined,\n      debug: undefined\n    };\n    this.delegate = delegate;\n  }\n\n  static create(keyring, delegate) {\n    return __awaiter(this, void 0, void 0, function* () {\n      return new Transport(keyring, delegate);\n    });\n  }\n\n  isOpened() {\n    return this.delegate.isOpened();\n  }\n\n  getDeviceID() {\n    return this.delegate.getDeviceID();\n  }\n\n  connect() {\n    return this.delegate.connect();\n  }\n\n  tryConnectDebugLink() {\n    return __awaiter(this, void 0, void 0, function* () {\n      let out = false;\n      if (this.delegate.tryConnectDebugLink && (yield this.delegate.tryConnectDebugLink())) out = true;\n      this.debugLink = out;\n      return out;\n    });\n  }\n\n  disconnect() {\n    return this.delegate.disconnect();\n  }\n\n  write(buf, debugLink) {\n    return __awaiter(this, void 0, void 0, function* () {\n      // break frame into segments\n      for (let i = 0; i < buf.length; i += utils_1.SEGMENT_SIZE) {\n        const segment = buf.slice(i, i + utils_1.SEGMENT_SIZE);\n        const padding = new Uint8Array(utils_1.SEGMENT_SIZE - segment.length);\n        const fragments = [];\n        fragments.push(new Uint8Array([utils_1.SEGMENT_SIZE]));\n        fragments.push(segment);\n        fragments.push(padding);\n        const fragmentBuffer = new Uint8Array(fragments.map(x => x.length).reduce((a, x) => a + x, 0));\n        fragments.reduce((a, x) => (fragmentBuffer.set(x, a), a + x.length), 0);\n        yield this.delegate.writeChunk(fragmentBuffer, debugLink);\n      }\n    });\n  }\n\n  read(debugLink) {\n    return __awaiter(this, void 0, void 0, function* () {\n      const first = yield this.delegate.readChunk(debugLink); // Check that buffer starts with: \"?##\" [ 0x3f, 0x23, 0x23 ]\n      // \"?\" = USB reportId, \"##\" = KeepKey magic bytes\n      // Message ID is bytes 4-5. Message length starts at byte 6.\n\n      const firstView = new DataView(first.buffer.slice(first.byteOffset, first.byteOffset + first.byteLength));\n      const valid = (firstView.getUint32(0) & 0xffffff00) === 0x3f232300;\n      const msgLength = firstView.getUint32(5);\n      if (!valid) throw new Error(\"message not valid\");\n      const buffer = new Uint8Array(9 + 2 + msgLength);\n      buffer.set(first.slice(0, Math.min(first.length, buffer.length)));\n\n      for (let offset = first.length; offset < buffer.length;) {\n        // Drop USB \"?\" reportId in the first byte\n        let next = (yield this.delegate.readChunk(debugLink)).slice(1);\n        buffer.set(next.slice(0, Math.min(next.length, buffer.length - offset)), offset);\n        offset += next.length;\n      }\n\n      return buffer;\n    });\n  }\n\n  getVendor() {\n    return \"KeepKey\";\n  }\n\n  getEntropy(length) {\n    if (typeof window !== \"undefined\" && (window === null || window === void 0 ? void 0 : window.crypto)) {\n      return window.crypto.getRandomValues(new Uint8Array(length));\n    }\n\n    const {\n      randomBytes\n    } = require(\"crypto\");\n\n    return randomBytes(length);\n  }\n\n  getFirmwareHash(firmware) {\n    return __awaiter(this, void 0, void 0, function* () {\n      if (typeof window !== \"undefined\" && (window === null || window === void 0 ? void 0 : window.crypto)) {\n        return new Uint8Array(yield window.crypto.subtle.digest({\n          name: \"SHA-256\"\n        }, firmware));\n      }\n\n      const {\n        createHash\n      } = require(\"crypto\");\n\n      const hash = createHash(\"sha256\");\n      hash.update(firmware);\n      return hash.digest();\n    });\n  }\n  /**\n   * Utility function to cancel all pending calls whenver one of them is cancelled.\n   */\n\n\n  cancellable(inProgress) {\n    return __awaiter(this, void 0, void 0, function* () {\n      try {\n        yield inProgress;\n      } catch (e) {\n        // Throw away the error, as the other context will handle it,\n        // unless it was a cancel, in which case we cancel everything.\n        if (core.isIndexable(e) && e.type === core.HDWalletErrorType.ActionCancelled) {\n          this.callInProgress = {\n            main: undefined,\n            debug: undefined\n          };\n          throw e;\n        }\n      }\n    });\n  }\n\n  lockDuring(action) {\n    return __awaiter(this, void 0, void 0, function* () {\n      this.callInProgress.main = (() => __awaiter(this, void 0, void 0, function* () {\n        yield this.cancellable(this.callInProgress.main);\n        return action();\n      }))();\n\n      return this.callInProgress.main;\n    });\n  }\n\n  handleCancellableResponse(messageType) {\n    return __awaiter(this, void 0, void 0, function* () {\n      const event = yield core.takeFirstOfManyEvents(this, [String(messageType), ...responseTypeRegistry_1.EXIT_TYPES]).toPromise();\n      return this.readResponse(false);\n    });\n  }\n\n  readResponse(debugLink) {\n    return __awaiter(this, void 0, void 0, function* () {\n      let buf;\n\n      do {\n        buf = yield this.read(debugLink);\n      } while (!buf);\n\n      const [msgTypeEnum, msg] = this.fromMessageBuffer(buf);\n      let event = core.makeEvent({\n        message_type: typeRegistry_1.messageNameRegistry[msgTypeEnum],\n        message_enum: msgTypeEnum,\n        message: msg.toObject(),\n        proto: msg,\n        from_wallet: true\n      });\n      this.emit(String(msgTypeEnum), event);\n      if (debugLink) return event;\n\n      if (msgTypeEnum === Messages.MessageType.MESSAGETYPE_FAILURE) {\n        const failureEvent = core.makeEvent({\n          message_type: core.Events.FAILURE,\n          message_enum: msgTypeEnum,\n          message: msg.toObject(),\n          from_wallet: true\n        });\n        this.emit(core.Events.FAILURE, failureEvent);\n        return failureEvent;\n      }\n\n      if (msgTypeEnum === Messages.MessageType.MESSAGETYPE_BUTTONREQUEST) {\n        this.emit(core.Events.BUTTON_REQUEST, core.makeEvent({\n          message_type: core.Events.BUTTON_REQUEST,\n          from_wallet: true\n        }));\n        this.userActionRequired = true;\n        return this.call(Messages.MessageType.MESSAGETYPE_BUTTONACK, new Messages.ButtonAck(), {\n          msgTimeout: core.LONG_TIMEOUT,\n          omitLock: true\n        });\n      }\n\n      if (msgTypeEnum === Messages.MessageType.MESSAGETYPE_ENTROPYREQUEST) {\n        const ack = new Messages.EntropyAck();\n        ack.setEntropy(this.getEntropy(32));\n        return this.call(Messages.MessageType.MESSAGETYPE_ENTROPYACK, ack, {\n          msgTimeout: core.LONG_TIMEOUT,\n          omitLock: true\n        });\n      }\n\n      if (msgTypeEnum === Messages.MessageType.MESSAGETYPE_PINMATRIXREQUEST) {\n        this.emit(core.Events.PIN_REQUEST, core.makeEvent({\n          message_type: core.Events.PIN_REQUEST,\n          from_wallet: true\n        }));\n        this.userActionRequired = true;\n        return this.handleCancellableResponse(Messages.MessageType.MESSAGETYPE_PINMATRIXACK);\n      }\n\n      if (msgTypeEnum === Messages.MessageType.MESSAGETYPE_PASSPHRASEREQUEST) {\n        this.emit(core.Events.PASSPHRASE_REQUEST, core.makeEvent({\n          message_type: core.Events.PASSPHRASE_REQUEST,\n          from_wallet: true\n        }));\n        this.userActionRequired = true;\n        return this.handleCancellableResponse(Messages.MessageType.MESSAGETYPE_PASSPHRASEACK);\n      }\n\n      if (msgTypeEnum === Messages.MessageType.MESSAGETYPE_CHARACTERREQUEST) {\n        this.emit(core.Events.CHARACTER_REQUEST, core.makeEvent({\n          message_type: core.Events.CHARACTER_REQUEST,\n          from_wallet: true\n        }));\n        this.userActionRequired = true;\n        return this.handleCancellableResponse(Messages.MessageType.MESSAGETYPE_CHARACTERACK);\n      }\n\n      if (msgTypeEnum === Messages.MessageType.MESSAGETYPE_WORDREQUEST) {\n        this.emit(core.Events.WORD_REQUEST, core.makeEvent({\n          message_type: core.Events.WORD_REQUEST,\n          from_wallet: true\n        }));\n        this.userActionRequired = true;\n        return this.handleCancellableResponse(Messages.MessageType.MESSAGETYPE_WORDACK);\n      }\n\n      return event;\n    });\n  }\n\n  call(msgTypeEnum, msg, options) {\n    var _a;\n\n    return __awaiter(this, void 0, void 0, function* () {\n      options !== null && options !== void 0 ? options : options = {};\n      (_a = options.msgTimeout) !== null && _a !== void 0 ? _a : options.msgTimeout = core.DEFAULT_TIMEOUT;\n      this.emit(String(msgTypeEnum), core.makeEvent({\n        message_type: typeRegistry_1.messageNameRegistry[msgTypeEnum],\n        message_enum: msgTypeEnum,\n        message: msg.toObject(),\n        proto: msg,\n        from_wallet: false\n      }));\n\n      const makePromise = () => __awaiter(this, void 0, void 0, function* () {\n        if ([Messages.MessageType.MESSAGETYPE_BUTTONACK, Messages.MessageType.MESSAGETYPE_PASSPHRASEACK, Messages.MessageType.MESSAGETYPE_CHARACTERACK, Messages.MessageType.MESSAGETYPE_PINMATRIXACK, Messages.MessageType.MESSAGETYPE_WORDACK].includes(msgTypeEnum)) {\n          this.userActionRequired = true;\n        }\n\n        yield this.write(this.toMessageBuffer(msgTypeEnum, msg), !!(options === null || options === void 0 ? void 0 : options.debugLink));\n        if (options === null || options === void 0 ? void 0 : options.noWait) return undefined;\n        const response = yield this.readResponse(!!(options === null || options === void 0 ? void 0 : options.debugLink));\n        this.userActionRequired = false;\n\n        if (response.message_enum === Messages.MessageType.MESSAGETYPE_FAILURE && response.message.code === Types.FailureType.FAILURE_ACTIONCANCELLED) {\n          this.callInProgress = {\n            main: undefined,\n            debug: undefined\n          };\n          throw new core.ActionCancelled();\n        }\n\n        if (response.message_type === core.Events.FAILURE) throw response;\n        return response;\n      });\n\n      if (options === null || options === void 0 ? void 0 : options.omitLock) return makePromise(); // See the comments in hdwallet-trezor-connect's call for why this weird\n      // sequence. We've got a very similar issue here that needs pretty much\n      // the same solution.\n\n      const lockKey = (options === null || options === void 0 ? void 0 : options.debugLink) ? \"debug\" : \"main\";\n\n      this.callInProgress[lockKey] = (() => __awaiter(this, void 0, void 0, function* () {\n        yield this.cancellable(this.callInProgress[lockKey]);\n\n        try {\n          return makePromise();\n        } finally {\n          this.userActionRequired = false;\n        }\n      }))();\n\n      return yield this.callInProgress[lockKey];\n    });\n  }\n\n  cancel() {\n    return __awaiter(this, void 0, void 0, function* () {\n      if (!this.userActionRequired) return;\n\n      try {\n        this.callInProgress = {\n          main: undefined,\n          debug: undefined\n        };\n        const cancelMsg = new Messages.Cancel();\n        yield this.call(Messages.MessageType.MESSAGETYPE_CANCEL, cancelMsg, {\n          noWait: this.userActionRequired\n        });\n      } catch (e) {\n        console.error(\"Cancel Pending Error\", e);\n      } finally {\n        this.callInProgress = {\n          main: undefined,\n          debug: undefined\n        };\n      }\n    });\n  }\n\n  toMessageBuffer(msgTypeEnum, msg) {\n    const messageBuffer = msg.serializeBinary();\n    const headerBuffer = new Uint8Array(8);\n    const headerView = new DataView(headerBuffer.buffer);\n    headerView.setUint8(0, 0x23);\n    headerView.setUint8(1, 0x23);\n    headerView.setUint16(2, msgTypeEnum);\n    headerView.setUint32(4, messageBuffer.byteLength);\n    const fragments = [headerBuffer, messageBuffer];\n    const fragmentBuffer = new Uint8Array(fragments.map(x => x.length).reduce((a, x) => a + x, 0));\n    fragments.reduce((a, x) => (fragmentBuffer.set(x, a), a + x.length), 0);\n    return fragmentBuffer;\n  }\n\n  fromMessageBuffer(buf) {\n    const typeID = new DataView(buf.buffer).getUint16(3);\n    const MType = typeRegistry_1.messageTypeRegistry[typeID];\n\n    if (!MType) {\n      const msg = new Messages.Failure();\n      msg.setCode(Types.FailureType.FAILURE_UNEXPECTEDMESSAGE);\n      msg.setMessage(\"Unknown message type received\");\n      return [Messages.MessageType.MESSAGETYPE_FAILURE, msg];\n    }\n\n    const msg = new MType();\n    const reader = new jspb.BinaryReader(buf, 9, buf.length - (9 + 2));\n    return [typeID, MType.deserializeBinaryFromReader(msg, reader)];\n  }\n\n  static failureMessageFactory(e) {\n    const msg = new Messages.Failure();\n    msg.setCode(Types.FailureType.FAILURE_UNEXPECTEDMESSAGE);\n\n    if (typeof e === \"string\") {\n      msg.setMessage(e);\n    } else {\n      msg.setMessage(String(e));\n    }\n\n    return msg.serializeBinary();\n  }\n\n}\n\nexports.Transport = Transport;","map":{"version":3,"mappings":"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","names":["Transport","core","constructor","keyring","delegate","main","undefined","debug","create","isOpened","getDeviceID","connect","tryConnectDebugLink","out","debugLink","disconnect","write","buf","i","length","utils_1","segment","slice","padding","Uint8Array","fragments","push","fragmentBuffer","map","x","reduce","a","set","writeChunk","read","first","readChunk","firstView","DataView","buffer","byteOffset","byteLength","valid","getUint32","msgLength","Error","Math","min","offset","next","getVendor","getEntropy","window","crypto","getRandomValues","randomBytes","require","getFirmwareHash","firmware","subtle","digest","name","createHash","hash","update","cancellable","inProgress","e","isIndexable","type","HDWalletErrorType","ActionCancelled","callInProgress","lockDuring","action","__awaiter","handleCancellableResponse","messageType","event","takeFirstOfManyEvents","String","responseTypeRegistry_1","toPromise","readResponse","msgTypeEnum","msg","fromMessageBuffer","makeEvent","message_type","typeRegistry_1","message_enum","message","toObject","proto","from_wallet","emit","Messages","MessageType","MESSAGETYPE_FAILURE","failureEvent","Events","FAILURE","MESSAGETYPE_BUTTONREQUEST","BUTTON_REQUEST","userActionRequired","call","MESSAGETYPE_BUTTONACK","ButtonAck","msgTimeout","LONG_TIMEOUT","omitLock","MESSAGETYPE_ENTROPYREQUEST","ack","EntropyAck","setEntropy","MESSAGETYPE_ENTROPYACK","MESSAGETYPE_PINMATRIXREQUEST","PIN_REQUEST","MESSAGETYPE_PINMATRIXACK","MESSAGETYPE_PASSPHRASEREQUEST","PASSPHRASE_REQUEST","MESSAGETYPE_PASSPHRASEACK","MESSAGETYPE_CHARACTERREQUEST","CHARACTER_REQUEST","MESSAGETYPE_CHARACTERACK","MESSAGETYPE_WORDREQUEST","WORD_REQUEST","MESSAGETYPE_WORDACK","options","_a","DEFAULT_TIMEOUT","makePromise","includes","toMessageBuffer","noWait","response","code","Types","FailureType","FAILURE_ACTIONCANCELLED","lockKey","cancel","cancelMsg","Cancel","MESSAGETYPE_CANCEL","console","error","messageBuffer","serializeBinary","headerBuffer","headerView","setUint8","setUint16","setUint32","typeID","getUint16","MType","Failure","setCode","FAILURE_UNEXPECTEDMESSAGE","setMessage","reader","jspb","BinaryReader","deserializeBinaryFromReader","failureMessageFactory","exports"],"sourceRoot":"","sources":["../src/transport.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}