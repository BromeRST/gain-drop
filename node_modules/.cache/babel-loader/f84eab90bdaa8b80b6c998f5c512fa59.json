{"ast":null,"code":"\"use strict\";\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  Object.defineProperty(o, k2, {\n    enumerable: true,\n    get: function () {\n      return m[k];\n    }\n  });\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\n\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\n\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n\n  __setModuleDefault(result, mod);\n\n  return result;\n};\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nvar _a;\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.WebUSBKeepKeyAdapter = exports.Adapter = exports.AdapterDelegate = void 0;\n\nconst core = __importStar(require(\"@shapeshiftoss/hdwallet-core\"));\n\nconst keepkey = __importStar(require(\"@shapeshiftoss/hdwallet-keepkey\"));\n\nconst transport_1 = require(\"./transport\");\n\nconst utils_1 = require(\"./utils\"); // This avoids a prompt ReferenceError if the module is imported outside a browser.\n\n\nconst webUSB = typeof window === \"object\" && ((_a = window === null || window === void 0 ? void 0 : window.navigator) === null || _a === void 0 ? void 0 : _a.usb);\n\nfunction assertWebUSB(webUSB) {\n  if (!webUSB) throw new core.WebUSBNotAvailable();\n}\n\nexports.AdapterDelegate = {\n  getDevices() {\n    return __awaiter(this, void 0, void 0, function* () {\n      assertWebUSB(webUSB);\n      const devices = (yield webUSB.getDevices()).filter(d => d.serialNumber !== undefined);\n      return devices.filter(x => x.vendorId === utils_1.VENDOR_ID && [utils_1.WEBUSB_PRODUCT_ID, utils_1.HID_PRODUCT_ID].includes(x.productId));\n    });\n  },\n\n  getDevice(serialNumber) {\n    return __awaiter(this, void 0, void 0, function* () {\n      assertWebUSB(webUSB);\n\n      try {\n        const out = yield webUSB.requestDevice({\n          filters: [{\n            vendorId: utils_1.VENDOR_ID,\n            productId: utils_1.WEBUSB_PRODUCT_ID,\n            serialNumber\n          }, {\n            vendorId: utils_1.VENDOR_ID,\n            productId: utils_1.HID_PRODUCT_ID,\n            serialNumber\n          }]\n        });\n        if (out.serialNumber === undefined) throw new Error(\"expected serial number\");\n        return out;\n      } catch (e) {\n        throw new core.WebUSBCouldNotPair(\"KeepKey\", String(core.isIndexable(e) ? e.message : e));\n      }\n    });\n  },\n\n  getTransportDelegate(device) {\n    return __awaiter(this, void 0, void 0, function* () {\n      return new transport_1.TransportDelegate(device);\n    });\n  },\n\n  registerCallbacks(handleConnect, handleDisconnect) {\n    assertWebUSB(webUSB);\n\n    function handleUSBEvent(connecting, e) {\n      return __awaiter(this, void 0, void 0, function* () {\n        const device = e.device;\n        if (device.vendorId !== utils_1.VENDOR_ID) return;\n        if (device.productId !== utils_1.WEBUSB_PRODUCT_ID) return;\n        return (connecting ? handleConnect : handleDisconnect)(device);\n      });\n    }\n\n    webUSB.addEventListener(\"connect\", handleUSBEvent.bind(null, true));\n    webUSB.addEventListener(\"disconnect\", handleUSBEvent.bind(null, false));\n  }\n\n};\nexports.Adapter = keepkey.Adapter.fromDelegate(exports.AdapterDelegate);\nexports.WebUSBKeepKeyAdapter = exports.Adapter;","map":{"version":3,"mappings":"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","names":["webUSB","window","navigator","_a","usb","assertWebUSB","core","WebUSBNotAvailable","exports","getDevices","devices","filter","d","serialNumber","undefined","x","vendorId","utils_1","includes","productId","getDevice","out","requestDevice","filters","Error","e","WebUSBCouldNotPair","String","isIndexable","message","getTransportDelegate","device","transport_1","registerCallbacks","handleConnect","handleDisconnect","handleUSBEvent","connecting","addEventListener","bind","keepkey","Adapter","fromDelegate"],"sourceRoot":"","sources":["../src/adapter.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}